직비 네트워크계층

NWK 계층은 데이터와 관리 서비스를 제공한다. NLDE(NWK Layer Data Entity)는 데이터 전송을 담당한다. 데이터 서비스는 NLDE 서비스 액세스 포인트(SAP)를 통해 접속된다. NWK 관리 의무는 NWK Layer Management Entity(NLME)가 처리한다. 다음 상위 계층은 NLME-SAP를 통해 NWK 관리 서비스를 이용할 수 있다. NWK 계층은 고유한 상수와 속성을 가지고 있다. 모든 NWK 상수는 nwkc로 시작한다. NWK 속성은 nwk로 시작한다. NWK 속성은 NIB(Network Information Base)에 저장된다. NWK 상수와 속성의 목록은 ZigBee 표준 문서에 수록되어 있다. APL 계층은 각각 NLME-GET 및 NLME-SET 기본값을 이용하여 NWK 속성을 읽고 수정할 수 있다. 
<br><br>
ZigBee 코디네이터의 NWK 계층은 네트워크의 각 장치에 16비트 네트워크 주소를 할당한다. PAN 코디네이터인 ZigBee 코디네이터는 네트워크에 가입하는 새로운 기기가 MAC 주소를 필요로 하는 경우 IEEE 802.15.4 MAC 주소를 할당한다. 네트워크 주소는 기기에 할당된 16비트 IEEE 802.15.4 MAC 단축 주소와 같아야 한다.
<br><br>
NWK 계층은 프레임이 네트워크에서 이동할 수 있는 거리를 제한한다. 거리는 홉의 수로 정의된다. 각 NWK 프레임에 (radius)반경이라 불리는 매개변수를 추가하여 최대 홉 수를 결정한다. 예를 들어 반경의 초기값이 3과 같다면 메시지는 3회 이상 전달되지 않는다. 메시지가 전달될 때마다 반지름 값이 감소하며, 반지름 값이 0이 되면 프레임은 더 이상 전달되지 않는다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53284660-dcc68600-379a-11e9-854a-d6d13348d94c.png)
<br>
통신 메커니즘은 브로드캐스트, 멀티캐스트 및 유니캐스트의 세 가지 일반적인 범주로 나눌 수 있다. 브로드캐스트 메시지는 메시지를 수신하는 모든 장치를 대상으로 한다. 멀티캐스팅 메커니즘은 메시지를 네트워크의 특정 장치 그룹에 전달한다. 마지막으로 유니캐스트는 메시지가 단일 장치를 위한 것일 때 사용된다. 유니캐스트 메시지는 의도한 장치의 특정 주소를 포함한다. 별도의 규정이 없는 한 유니캐스트는 기본 통신 모드다.<br>

### 브로드캐스팅
브로드캐스팅에서는, 메시지는 주소나 PAN 식별자에 관계없이, 특정 주파수 채널을 청취하는 모든 기기가 수신하는 것을 목적으로 한다. 장치가 패킷을 수신할 때마다 장치는 패킷에 제공된 목적지 주소를 확인하여 장치가 패킷의 의도된 수신자인지 확인한다. IEEE 802.15.4 네트워크에서 방송하기 위해서는 짧은 주소 지정 모드를 사용하고 대상 주소를 0xffff로 설정한다. 이 주소는 패킷을 자신의 주소로 수신하는 모든 장치에 의해 수신된다. PAN 식별자는 0xffff로 설정할 수도 있다. 수신 장치는 유효한 PAN 식별자로 0xffff를 받아들인다. 0xffff의 MAC 주소는 브로드캐스트 주소로 알려져 있다. IEEE 802.15.4는 복수의 네트워크를 통해 메시지를 브로드캐스팅하기 위한 브로드캐스트 PAN 식별자(즉, 0xffff)의 이용을 지원하지만, ZigBee 표준은 복수의 네트워크를 통한 방송을 허용하지 않으며, 그리고 PAN 식별자는 항상 0xffff 대신에 ZigBee 네트워크의 PAN 식별자로 설정된다. 네트워크 내의 어떤 장치의 APS 하위 계층은 NWK 계층 데이터 서비스를 이용하여 브로드캐스팅 전송을 시작할 수 있다.
<br><br>
대규모 네트워크에서는 방송 메시지를 수신하는 모든 장치가 메시지 발신자에게 확인응답을 다시 송신할 것을 기대하는 것은 어렵고 불필요할 것이다. 따라서, 메시지가 방송될 때, 엔드 디바이스는 메시지의 성공적인 수신에 대한 확인응답을 보낼 수 없다. 대신에, ZigBee 코디네이터와 ZigBee 라우터는 그들의 이웃한 기기가 성공적으로 메시지를 전달했는지 여부를 확인한다. 이것은 수동적 확인응답 메커니즘으로 알려져 있다. 수동적 확인응답에서, 기기가 메시지를 브로드캐스트한 후 수신 모드로 들어가 인접 기기에 의해 동일한 프레임이 재방송될 때까지 기다린다. 재방송 메시지는 이웃 기기가 브로드캐스팅 메시지를 성공적으로 수신하고 전달했다는 것을 나타낸다.
<br><br>
ZigBee 코디네이터와 ZigBee 라우터는 그들이 브로드캐스트 트랜잭션 테이블(BTT,broadcast transaction table)이라는 테이블에서 방송한 모든 메시지의 기록을 유지한다. 기록 자체는 브로드캐스트 트랜잭션 기록(broadcast transaction record)으로 알려져 있으며, 방송 프레임의 시퀀스 번호와 소스 주소를 담고 있다. 모든 ZigBee 라우터는 NWK 계층에서 적어도 하나의 프레임을 버퍼링할 수 있어야 한다. 버퍼링 기능은 방송의 재전송에 도움이 된다. 각 BTR은 한정된 기간 동안만 유효하며, 생성되고부터 nwkNetworkBroadcastDeliveryTime만큼이 지나면 만료된다. 새로운 BTR이 생성되고 있고 BTT가 가득 찬 경우 만료된 BTR을 덮어쓸 수 있다.
<br><br>
기기가 한가한(idle) 상태일 때(즉, macRxOnIdle이 FALSE로 설정되어 있을 때) ZigBee 끝 장치가 수신기를 ON 모드로 유지하지 않는 경우, 장치는 브로드캐스트 메시지 릴레이에 참여하지 않거나 BTT를 유지하지 않는다. FALSE로 설정된 macRxOnWhenIdle이 있는 ZigBee 라우터가 브로드캐스트 메시지를 수신하면, 브로드캐스트 메커니즘을 사용하지 않는다. 대신 유니캐스트를 이용해 지연 없이 자신의 이웃들에게 개별적으로 메시지를 전달할 것이다. 주소 필드는 브로드캐스트 주소가 아닌 의도된 특정 디바이스의 주소를 포함한다.
<br><br>
브로드캐스팅 중에 메시지는 복수의 디바이스에 의해 중계되고, 숨겨진 노드 문제로 인해 충돌할 가능성이 있다. 이 충돌을 줄이기 위해 NWK 계층은 각 재전송 전에 기기가 무작위 시간 동안 기다려야 한다고 요구한다. 이 무작위 대기 기간은 방송 지터(jitter)라고 불린다. 방송 지터의 길이는 nwkcMaxBroadcastJitter 속성의 값(밀리초)보다 작아야 한다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53285019-ee119180-379e-11e9-8a41-be5c0c495b43.png)
<br>
위 그림 3.31의 시퀀스 차트는 브로드캐스팅 트랜잭션을 나타내고 있다. BTT는 각 장치가 이웃 장치로부터 브로드캐스트 전송을 수신한 후에 업데이트된다. 장치 A는 브로드캐스팅을 시작하고 장치 B로부터 브로드캐스팅 프레임을 다시 수신한다. 장치 A가 브로드캐스팅 메시지를 두 번째로 수신하면 장치 A가 이미 방송 프레임을 수신했기 때문에 프레임을 무시한다. 장치 B는 프레임을 브로드캐스트하고 수동적 확인응답(장치 C로부터의 브로드캐스트 프레임)을 기다린다. 장치 B가 nwkPassiveAckTimeout 초의 기간 동안 대기하고 수동적 확인응답이 수신되지 않으면 장치 B는 프레임을 재전송한다. 그림 3.31의 예에서, 장치 B는 수동적 확인응답을 받았기 때문에 프레임을 재송신하지 않는다.
<br><br>

### 멀티캐스팅
멀티캐스트에서, 메시지는 전체 네트워크 대신에 동일한 네트워크 내의 장치 그룹으로 전달된다. 예를 들어, 조명 제어 애플리케이션에서 스위치 역할을 하는 장치에 의해 전송되는 단일 프레임은 집 안의 조명 그룹을 켜거나 끌 수 있다. 비록 각각의 빛에 대한 연속 유니캐스트 전송으로 동일한 결과를 달성하는 것이 가능하지만, 단일 멀티캐스트는 장치 그룹에 동일한 메시지를 전달하는 더 효율적인 방법이다.
<br><br>
각 그룹은 16비트 멀티캐스트 그룹 ID로 식별된다. 같은 그룹의 장치는 그룹 멤버로 알려져 있다. 장치는 하나 이상의 멀티캐스트 그룹의 멤버일 수 있다. 각 장치는 멀티캐스트 테이블(nwkGroupIDTable)이라는 테이블에 그것의 멀티캐스트 그룹 멤버쉽 목록을 보관한다. 
<br><br>
멀티 캐스팅을 사용하여 구성원에게 도달하려면 장치가 멀티 캐스트 그룹의 구성원이어야 할 필요는 없다. 멀티캐스팅에는 멤버 모드와 비회원 모드의 두 가지 모드가 있다. 멤버 모드에서, 멀티캐스트는 멤버 장치에 의해 시작되고 그것의 멀티캐스트 그룹의 멤버들에게 보내진다. 비구성원 모드에서, 멀티캐스트 그룹의 멤버가 아닌 장치는 메시지를 멀티캐스트 그룹 멤버로 라우팅하며, 여기서 메시지는 그룹의 멤버들에게 보내질 것이다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53287537-ee228900-37c0-11e9-9d34-3b70d26ca937.png)
<br>
위 그림 3.32는 회원 모드와 비회원 모드 멀티캐스팅을 설명하고있다. NWK 데이터 프레임 자체는 이 프레임이 멤버 장치에 의해 전송되고 있는지 비회원 장치에 의해 전송되고 있는지를 명확하게 하는 필드(멀티캐스트 모드 필드)를 가지고 있다. 이 예에서, 멀티캐스트는 비회원 장치에 의해 개시된다. 디바이스는 APL 계층으로부터 수신된 페이로드에 포함된 멀티캐스트 그룹 ID가 그것의 멀티캐스트 테이블에 저장된 어떤 장치 멀티캐스트 그룹 ID와도 일치하지 않는다면, 해당 멀티캐스트 그룹의 구성원이 아니라는 것을 "알고"있다. 그림 3.32의 시작 디바이스(소스 디바이스)는 NWK 데이터 프레임을 구성하고 프레임의 멀티캐스트 모드 필드를 비회원 모드로 설정한다.
<br><br>
이 전송 이전에 경로 발견이 수행되었다고 가정하면, 소스 장치는 다음 홉의 주소를 알고 있다. 그것은 연속 유니캐스트를 통해 이 프레임을 멤버 디바이스로 유도하는 경로가 이미 확립되어 있다는 것을 의미한다. 소스 디바이스는 다음 홉의 주소와 동일한 목적지 주소 필드를 설정한다. 프레임을 수신하는 다음 디바이스도 비회원 디바이스로 유니캐스트를 사용하여 프레임을 다음 디바이스로 전달한다. 이 과정은 멀티캐스트 그룹의 멤버인 장치에 의해 프레임이 수신될 때까지 계속된다.
<br><br>
멤버 디바이스는 수신된 프레임의 멀티캐스트 모드 필드를 변경하여 메시지가 멤버 디바이스로부터 전송되고 있음을 나타낼 것이다. 이 시점으로부터, 멤버 디바이스에 의해 개시된 것처럼 메시지를 송신한다. 멀티캐스트 멤버 장치는 메시지를 유니캐스트하지 않는다. 대신 프레임의 목적지 주소를 브로드캐스트 주소(0xffffff)와 동일하게 설정해 메시지를 브로드캐스팅 한다. 멤버 모드 멀티캐스트는 마치 브로드캐스트인 것처럼 BTT에 기록된다. 멀티캐스트에서는, 브로드캐스트와 대조적으로, 수동적 확인응답은 없다.
<br><br>
브로드캐스팅에 참여하는 모든 장치는 임의의 시간(nwkcMaxBroadcastJitter 속성의 값 이하)을 기다린 후 프레임을 브로드캐스팅한다. 이 브로드캐스트 프레임은 멤버와 비회원 모두에게 도달할 수 있다(그림 3.32). 회원과 비회원 모두 BTT가 가득 차 있지 않고 이전에 동일한 프레임을 브로드캐스트하지 않은 경우, 수신된 프레임을 재방송한다.
<br><br>
멀티캐스팅에서, 멀티캐스트 프레임이 비회원 장치에 의해 재방송되는 횟수를 제한할 수 있다. 브로드캐스트 프레임에는 비회원 반경(radius)이라고 불리는 필드가 있는데, 비회원 장치에 의해 프레임이 재방송될 때마다 이 필드가 감소된다. 비회원 반경 필드가 0이 되면 프레임은 더 이상 비회원 기기에 의해 재방송되지 않는다.
<br><br>
유일한 예외로 비회원 반경 필드를 007로 설정하면 프레임 재방송 횟수에 제한이 없음을 나타낸다. 또한, 멤버 장치가 멀티캐스트 프레임을 재방송할 때마다, 비회원 반경 필드를 허용되는 최대 비회원 반경으로 설정한다. 최대 비회원 반경의 값은 멀티캐스팅 되고 있는 프레임에도 포함된다. ZigBee 표준에서 멀티캐스트는 데이터 프레임 전송에만 사용되며, 명령 프레임은 멀티캐스트를 사용한 전송이 허용되지 않는다.

### 다대일 통신(many to one conmunication)

![image](https://user-images.githubusercontent.com/38284141/53295562-8bbd9d00-3841-11e9-8753-9e3b8d97d0ad.png)
<br>
그림 3.33은 하나의 디바이스가 동일한 네트워크 내의 복수의 디바이스에서 메시지를 수신하는 통신 시나리오를 나타낸다. 이것은 다대일 커뮤니케이션으로 알려져 있다. 메시지를 수신하는 디바이스를 싱크(sink)라고 한다. ZigBee 무선 네트워킹에서 싱크는 주어진 반경 내에 있는 모든 ZigBee 라우터와 ZigBee 코디네이터로부터 스스로 경로를 설정한다.

### 계층적(트리) 토폴로지

![image](https://user-images.githubusercontent.com/38284141/53295684-12737980-3844-11e9-9ffe-84f46ed9bdb2.png)
<br>

그림 3.34 에 나타낸 트리 네트워크는 트리의 루트 역할을 하는 ZigBee 코디네이터에서 시작한다. ZigBee 코디네이터나 라우터는 상위 디바이스로 작용하고 네트워크의 다른 디바이스로부터 연결을 받아들일 수 있다. 부모 디바이스에 연결된 장치는 자식 디바이스로 알려져 있다. 자식을 위한 메시지는 부모를 통해 전달될 수 있다. ZigBee 엔드 디바이스는 라우팅 기능이 부족하기 때문에 자식 역할만 할 수 있다. 트리 위상은 계층적 위상으로도 알려져 있다.
<br><br>
네트워크 깊이는 부모/자식 연결만 사용되는 경우, 프레임이 ZigBee 코디네이터에 도달하기 위해 필요한 최소 홉 수로 정의된다. ZigBee 코디네이터의 직계 자식이 네트워크 깊이가 1로, 한 홉으로 직접 지그비 코디네이터에게 프레임을 보낼 수 있기 때문이다. 지그비 코디네이터 자체는 깊이가 0이다.
<br><br>
ZigBee 표준은 트리 네트워크의 디바이스에 주소를 할당하는 메커니즘을 제공한다. 이것은 기본 분산 주소 할당(default distributed address allocation )으로 알려져 있다. 그러나, 개발자들은 그들 자신의 주소 할당 방법을 사용할 수 있다. ZigBee 코디네이터가 네트워크 구축을 시작할 때 nwkUseTreeAddrAlloc 속성이 TRUE로 설정된 경우, 코디네이터는 기본 분산 주소 지정 체계를 사용한다. 분산 주소 지정 시, ZigBee 코디네이터는 각각의 잠재적 부모들에게 네트워크 주소의 하위 블록을 제공한다. 부모는 자식에게 이 주소를 할당할 것이다. ZigBee 코디네이터는 각 부모에 허용되는 최대 자식 수를 결정한다. nwkUseTreeAddrAlloc이 FALSE로 설정되어 있는 경우, APL 계층은 NWK 계층에 대해 사용자 정의 주소 지정을 제공한다.
<br><br>
기본 주소 할당은 간단히 깊이와 최대 자식 수를 주소 할당에 사용한다. 주소 할당에 영향을 주는 파라미터는 다음과 같다.
<br>
1. Lm 네트워크 최대 깊이 nwkMaxDepth <br>
2. Cm 부모가 받아들일 수 있는 자식의 최대 수 nwkMaxChildren <br>
3. Rm 부모가 받아들일 수 있는 경로설정이 가능한 자식의 최대 수 nwkMaxRouters <br>
4. d 네트워크에 있는 디바이스의 깊이 <br>
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53295887-536d8d00-3848-11e9-9930-5b3c66453f9c.png)
<br>
위 그림 3.35는 Lm = 3, Cm = Rm = 2인 경우에 주소 할당의 예를 보여준다. 주소 할당은 직비 코디네이터에게 0번 주소를 할당(addr = 0)함으로써 시작한다. 나머지 디바이스들의 주소를 지정하기 위해, 다음과 같은 간단한 함수가 소개됐다.<br>
![image](https://user-images.githubusercontent.com/38284141/53295915-dee71e00-3848-11e9-9793-bfecc024a341.png)
<br>
그림 3.35의 예에서, 각 깊이의 Cskip(d)의 값이 계산됐다. 각 깊이에서, 두 개의 라우팅 가능 디바이스의 주소 간의 차이는 그들 부모의 Cskip의 값의 정수배다. 예를 들어 그림 3.35에서 장치 X 주소는 ZigBee 코디네이터 주소(addr =1)의 단일 증가분이다. 기기 Y 주소는 기기 X 주소 더하기 그 부모의 Cskip 값(Ckip=7)이다. 따라서 장치 Y의 주소는 8(addr = 8)과 같다. 라우팅이 가능한 나머지 장치의 주소는 이와 유사하게 결정할 수 있다.
<br><br>
계산된 Cskip 값이 디바이스에 대해 0이 되면, 디바이스가 어떤 자식도 받아들일 수 없다는 뜻이다. 그림 3.35에서, Cskip 값은 3의 깊이에 있는 모든 기기에 대해 0과 같다. 따라서 깊이 3의 어떤 디바이스도 엔드 디바이스로만 작동할 수 있다. 라우팅이 불가능한 엔드 디바이스의 주소는 다르게 계산된다. 각 엔드 디바이스의 주소는 다음과 같은 방정식을 사용하여 할당된다.
![image](https://user-images.githubusercontent.com/38284141/53296023-a2b4bd00-384a-11e9-8c87-9195bd9cf97b.png)
<br>
예를 들어 그림 3.35에서 디바이스 Z와 연결된 엔드 디바이스는 다음과 같은 주소를 가질 것이다.
<br>
첫 번째 엔드 디바이스 = 9 + 0 x 2 + 1 = 10<br>
두 번째 엔드 디바이스 = 9 + 0 x 2 + 2 = 11<br>
<br>
디바이스가 다른 디바이스를 대신하여 목적지를 향해 메시지를 전달할 것으로 예상되는 경우, cskip (d )가 도움이 될 수 있다. 릴레이 디바이스는 대상 디바이스가 릴레이 디바이스의 후손인지 여부를 알아야 한다. 중계 디바이스가 깊이 d에 있고 그것의 주소가 A와 같다면, 목적지 주소가 D인 목적지 디바이스는 다음과 같은 관계가 사실이라면 중계 디바이스의 후손이 된다.
<br>
A < D < A + Cskip(d-1)
<br>
예를 들어, 그림 3.35에서 디바이스 Y는 깊이가 1이고, 주소가 8(A = 8)이다. 그러면 디바이스 Y는 11의 목적지 주소로 전달되야하는 메시지를 받는다. 디바이스 Y는 다음식을 이용해 목적지 주소가 그것의 후손중 하나라는 걸 인지한다.<br>
8 < 11 < 8 + 7 <br>
<br>
이 사실을 인지한 후에 목적지는 디바이스의 후손이고, 다음 단계는 다음 홉의 주소를 계산하는 것이다. 만약 목적지가 디바이스 자식중 하나라면, 다음 홉의 주소는 목적지 주소와 같을 것이다. 만약 목적지가 자식이 아니고 후손인 경우, 다음 홉의 주소는 다음과 같은 방정식으로 계산된다.<br>
![image](https://user-images.githubusercontent.com/38284141/53296561-c7159700-3854-11e9-976c-4d74f7679a98.png)
<br>
함수 int는 임의의 숫자의 정수 부분만 반환한다. 예를 들어 int(4.95)는 4와 같다. <br>
그림 3.35에서, 장치 Y가 목적지 주소 11에 메시지를 중계하는 라우터 역할을 할 때, 다음 홉의 주소는 9가 될 것이다.<br>
<br>
![image](https://user-images.githubusercontent.com/38284141/53296571-080dab80-3855-11e9-8080-72da4515a95f.png)
<br>
소스 디바이스는 프레임 전송을 시작하는 디바이스다. 트리 토폴로지에서 장치는 프레임이 유효한 경로를 따라 수신된 경우에만 프레임을 중계한다. 경로는 다음 조건 중 하나가 충족될 경우 유효하다.<br><br>
1. 프레임을 자식 중 하나의 디바이스로부터 받고, 소스 디바이스가 그 자식의 후손인 경우<br>
2. 프레임을 부모 디바이스로부터 받고, 소스 디바이스가 그 디바이스의 후손이 아닌 경우<br>
<br>
스타 토폴로지는 네트워크에서 유일한 부모가 ZigBee 코디네이터인 트리 네트워크의 특별한 형태로 간주될 수 있다. 스타 네트워크에서는 모든 자식이 1의 깊이에 있으며, 지그비 코디네이터와 직접 커뮤니케이션한다. 어느 자식도 스타 네트워크에서 라우터 역할을 하지 않는다. 스타 토폴로지의 디바이스는 ZigBee 코디네이터 이외의 어떤 디바이스와도 직접 통신할 수 없다. 여기서 논의된 주소 할당 방법은 ZigBee-2006과 ZigBee-2007 모두에 적용된다. ZigBee-Pro는 확률적 주소 할당도 지원한다.
<br><br>

### mesh 토폴로지
메쉬 토폴로지에서는, 트리 토폴로지과 대조적으로, 계층 관계가 없다. 메시 토폴로지의 어떤 디바이스도 메시지 발신자를 대신하여 메시지를 전달하기 위해 라우팅이 가능한 디바이스를 이용하거나 직접 다른 디바이스에 접촉하려고 시도할 수 있다. 메쉬 토폴로지에서는, 필요에 따라 소스 디바이스에서 목적지까지의 경로를 생성해, 환경이 변하면 수정할 수 있다. 경로를 만들고 수정할 수 있는 메쉬 네트워크의 능력은 무선 연결의 신뢰성을 동적으로 높인다. 어떤 이유로든 소스 디아비스가 이전에 설정된 경로를 사용하여 목적지 디바이스와 통신할 수 없는 경우, 네트워크 내의 라우팅 가능 디바이스는 소스 디바이스에서 목적지 디바이스로 가는 대체 경로를 찾기 위해 협력할 수 있다.
<br>

## 라우팅 
라우팅은 메시지가 목적지 디바이스로 전달될 경로를 선택하는 과정이다. ZigBee 코디네이터와 라우터는 네트워크에서 경로를 발견하고 유지해야 한다. ZigBee 엔드 디바이스는 경로 검색을 수행할 수 없으며, ZigBee 코디네이터 또는 라우터는 엔드 디바이스를 대신하여 경로 검색을 수행한다.
<br>
경로의 길이(L)는 경로의 디바이스 수로 정의되어 있다. 그림 3.36은 길이 5(L5), 길이 7(L7)의 2개 경로의 예를 보여주고 있다. 한 경로에서 두 개의 연속적인 디바이스들 사이의 연결은 링크라고 불린다. 링크는 그림 3.36에 L1부터 L4까지 번호가 매겨진다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53296883-29bc6200-3858-11e9-89d4-628a14b7964f.png)
<br>
링크 품질, 홉 수 및 에너지 절약 고려사항과 같은 매개변수를 사용하여 각 라우팅 시나리오에 대한 최적의 경로를 결정할 수 있다. 이 과정을 단순화하기 위해서, 각 링크는 링크 비용과 연관되어 있다. 각 링크에서의 패킷 전달의 성공 확률은 링크 비용을 결정할 것이다. 패킷 전송 성공 확률이 낮을수록 링크 비용은 높아진다. 각 링크의 비용은 그림 3.36에서 C{[Di,D+i]}으로 표시된다.<br>
<br>
링크 비용을 결정하는 다양한 방법이 있다. 직비 표준은 다음과 같은 방정식을 사용한다.<br>
![image](https://user-images.githubusercontent.com/38284141/53296921-37261c00-3859-11e9-93f3-0e5bc039bab0.png)
<br>
C {L}은 링크 L의 비용이다. 링크 L에서의 패킷 전달 성공 확률은 PL로 나타낸다. round 함수는 숫자를 가장 가까운 정수 값으로 반올림한다. 비용은 항상 0에서 7사이의 정수다. 예를 들어 PL이 80%이면 링크 비용은 정수 2가 된다.
![image](https://user-images.githubusercontent.com/38284141/53296941-06de7d80-3859-11e9-99ea-155a0aff2a1b.png)
<br>
패킷 전송 성공 확률(PL)은 다양한 방법을 사용하여 추정할 수 있으며, ZigBee 표준은 구현자가 자신의 애플리케이션에 가장 적합한 방법을 선택할 수 있도록 한다. 단, 패킷의 성공적인 전달 가능성에 대한 초기 추정치는 평균 LQI에 근거해야 한다. LQI는 수신된 각 패킷에 대해 기록되며, 신호 에너지나 SNR을 조사한다. 일반적으로, LQI가 증가함에 따라 패킷의 성공적인 수신 가능성은 증가한다. 링크 비용을 계산하는 간단한 방법은 룩업 테이블을 사용하여 LQI의 다른 레벨을 0~7의 링크 비용 수준에 직접 매핑하는 것이다. 이 표는 보통 몇 가지 실험의 평균 결과를 바탕으로 만들어진다.<br>
<br>
다른 경로를 비교하기 위해, 각 경로는 경로 비용과 연관된다. 경로 비용(C{P})은 단순히 경로를 구성하는 링크의 비용을 합산한 것이다.<br>
![image](https://user-images.githubusercontent.com/38284141/53297833-9c810980-3867-11e9-9f0e-920b5713df4c.png)
<br>
경로 비용이 가장 저렴한 노선은 패킷의 성공적인 전달을 위한 최선의 기회를 갖게 될 것이다. <br>
ZigBee 코디네이터와 라우터는 라우팅 테이블을 생성하고 유지한다(표 3.9). <br>
![image](https://user-images.githubusercontent.com/38284141/53297846-d6521000-3867-11e9-9a74-da4956b46496.png)
<br>
라우팅 테이블은 메시지를 특정 목적지로 라우팅할 때 다음 홉을 결정하기 위해 사용된다. 상태 필드는 경로의 상태를 결정한다. 라우팅 테이블 용량이라는 용어는 장치가 라우팅 테이블을 사용하여 특정 목적지 주소로 경로를 설정할 수 있음을 의미한다.
