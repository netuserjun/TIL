직비 네트워크계층

NWK 계층은 데이터와 관리 서비스를 제공한다. NLDE(NWK Layer Data Entity)는 데이터 전송을 담당한다. 데이터 서비스는 NLDE 서비스 액세스 포인트(SAP)를 통해 접속된다. NWK 관리 의무는 NWK Layer Management Entity(NLME)가 처리한다. 다음 상위 계층은 NLME-SAP를 통해 NWK 관리 서비스를 이용할 수 있다. NWK 계층은 고유한 상수와 속성을 가지고 있다. 모든 NWK 상수는 nwkc로 시작한다. NWK 속성은 nwk로 시작한다. NWK 속성은 NIB(Network Information Base)에 저장된다. NWK 상수와 속성의 목록은 ZigBee 표준 문서에 수록되어 있다. APL 계층은 각각 NLME-GET 및 NLME-SET 기본값을 이용하여 NWK 속성을 읽고 수정할 수 있다. 
<br><br>
ZigBee 코디네이터의 NWK 계층은 네트워크의 각 장치에 16비트 네트워크 주소를 할당한다. PAN 코디네이터인 ZigBee 코디네이터는 네트워크에 가입하는 새로운 기기가 MAC 주소를 필요로 하는 경우 IEEE 802.15.4 MAC 주소를 할당한다. 네트워크 주소는 기기에 할당된 16비트 IEEE 802.15.4 MAC 단축 주소와 같아야 한다.
<br><br>
NWK 계층은 프레임이 네트워크에서 이동할 수 있는 거리를 제한한다. 거리는 홉의 수로 정의된다. 각 NWK 프레임에 (radius)반경이라 불리는 매개변수를 추가하여 최대 홉 수를 결정한다. 예를 들어 반경의 초기값이 3과 같다면 메시지는 3회 이상 전달되지 않는다. 메시지가 전달될 때마다 반지름 값이 감소하며, 반지름 값이 0이 되면 프레임은 더 이상 전달되지 않는다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53284660-dcc68600-379a-11e9-854a-d6d13348d94c.png)
<br>
통신 메커니즘은 브로드캐스트, 멀티캐스트 및 유니캐스트의 세 가지 일반적인 범주로 나눌 수 있다. 브로드캐스트 메시지는 메시지를 수신하는 모든 장치를 대상으로 한다. 멀티캐스팅 메커니즘은 메시지를 네트워크의 특정 장치 그룹에 전달한다. 마지막으로 유니캐스트는 메시지가 단일 장치를 위한 것일 때 사용된다. 유니캐스트 메시지는 의도한 장치의 특정 주소를 포함한다. 별도의 규정이 없는 한 유니캐스트는 기본 통신 모드다.<br>

### 브로드캐스팅
브로드캐스팅에서는, 메시지는 주소나 PAN 식별자에 관계없이, 특정 주파수 채널을 청취하는 모든 기기가 수신하는 것을 목적으로 한다. 장치가 패킷을 수신할 때마다 장치는 패킷에 제공된 목적지 주소를 확인하여 장치가 패킷의 의도된 수신자인지 확인한다. IEEE 802.15.4 네트워크에서 방송하기 위해서는 짧은 주소 지정 모드를 사용하고 대상 주소를 0xffff로 설정한다. 이 주소는 패킷을 자신의 주소로 수신하는 모든 장치에 의해 수신된다. PAN 식별자는 0xffff로 설정할 수도 있다. 수신 장치는 유효한 PAN 식별자로 0xffff를 받아들인다. 0xffff의 MAC 주소는 브로드캐스트 주소로 알려져 있다. IEEE 802.15.4는 복수의 네트워크를 통해 메시지를 브로드캐스팅하기 위한 브로드캐스트 PAN 식별자(즉, 0xffff)의 이용을 지원하지만, ZigBee 표준은 복수의 네트워크를 통한 방송을 허용하지 않으며, 그리고 PAN 식별자는 항상 0xffff 대신에 ZigBee 네트워크의 PAN 식별자로 설정된다. 네트워크 내의 어떤 장치의 APS 하위 계층은 NWK 계층 데이터 서비스를 이용하여 브로드캐스팅 전송을 시작할 수 있다.
<br><br>
대규모 네트워크에서는 방송 메시지를 수신하는 모든 장치가 메시지 발신자에게 확인응답을 다시 송신할 것을 기대하는 것은 어렵고 불필요할 것이다. 따라서, 메시지가 방송될 때, 엔드 디바이스는 메시지의 성공적인 수신에 대한 확인응답을 보낼 수 없다. 대신에, ZigBee 코디네이터와 ZigBee 라우터는 그들의 이웃한 기기가 성공적으로 메시지를 전달했는지 여부를 확인한다. 이것은 수동적 확인응답 메커니즘으로 알려져 있다. 수동적 확인응답에서, 기기가 메시지를 브로드캐스트한 후 수신 모드로 들어가 인접 기기에 의해 동일한 프레임이 재방송될 때까지 기다린다. 재방송 메시지는 이웃 기기가 브로드캐스팅 메시지를 성공적으로 수신하고 전달했다는 것을 나타낸다.
<br><br>
ZigBee 코디네이터와 ZigBee 라우터는 그들이 브로드캐스트 트랜잭션 테이블(BTT,broadcast transaction table)이라는 테이블에서 방송한 모든 메시지의 기록을 유지한다. 기록 자체는 브로드캐스트 트랜잭션 기록(broadcast transaction record)으로 알려져 있으며, 방송 프레임의 시퀀스 번호와 소스 주소를 담고 있다. 모든 ZigBee 라우터는 NWK 계층에서 적어도 하나의 프레임을 버퍼링할 수 있어야 한다. 버퍼링 기능은 방송의 재전송에 도움이 된다. 각 BTR은 한정된 기간 동안만 유효하며, 생성되고부터 nwkNetworkBroadcastDeliveryTime만큼이 지나면 만료된다. 새로운 BTR이 생성되고 있고 BTT가 가득 찬 경우 만료된 BTR을 덮어쓸 수 있다.
<br><br>
기기가 한가한(idle) 상태일 때(즉, macRxOnIdle이 FALSE로 설정되어 있을 때) ZigBee 끝 장치가 수신기를 ON 모드로 유지하지 않는 경우, 장치는 브로드캐스트 메시지 릴레이에 참여하지 않거나 BTT를 유지하지 않는다. FALSE로 설정된 macRxOnWhenIdle이 있는 ZigBee 라우터가 브로드캐스트 메시지를 수신하면, 브로드캐스트 메커니즘을 사용하지 않는다. 대신 유니캐스트를 이용해 지연 없이 자신의 이웃들에게 개별적으로 메시지를 전달할 것이다. 주소 필드는 브로드캐스트 주소가 아닌 의도된 특정 디바이스의 주소를 포함한다.
<br><br>
브로드캐스팅 중에 메시지는 복수의 디바이스에 의해 중계되고, 숨겨진 노드 문제로 인해 충돌할 가능성이 있다. 이 충돌을 줄이기 위해 NWK 계층은 각 재전송 전에 기기가 무작위 시간 동안 기다려야 한다고 요구한다. 이 무작위 대기 기간은 방송 지터(jitter)라고 불린다. 방송 지터의 길이는 nwkcMaxBroadcastJitter 속성의 값(밀리초)보다 작아야 한다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53285019-ee119180-379e-11e9-8a41-be5c0c495b43.png)
<br>
위 그림 3.31의 시퀀스 차트는 브로드캐스팅 트랜잭션을 나타내고 있다. BTT는 각 장치가 이웃 장치로부터 브로드캐스트 전송을 수신한 후에 업데이트된다. 장치 A는 브로드캐스팅을 시작하고 장치 B로부터 브로드캐스팅 프레임을 다시 수신한다. 장치 A가 브로드캐스팅 메시지를 두 번째로 수신하면 장치 A가 이미 방송 프레임을 수신했기 때문에 프레임을 무시한다. 장치 B는 프레임을 브로드캐스트하고 수동적 확인응답(장치 C로부터의 브로드캐스트 프레임)을 기다린다. 장치 B가 nwkPassiveAckTimeout 초의 기간 동안 대기하고 수동적 확인응답이 수신되지 않으면 장치 B는 프레임을 재전송한다. 그림 3.31의 예에서, 장치 B는 수동적 확인응답을 받았기 때문에 프레임을 재송신하지 않는다.
<br><br>

### 멀티캐스팅
멀티캐스트에서, 메시지는 전체 네트워크 대신에 동일한 네트워크 내의 장치 그룹으로 전달된다. 예를 들어, 조명 제어 애플리케이션에서 스위치 역할을 하는 장치에 의해 전송되는 단일 프레임은 집 안의 조명 그룹을 켜거나 끌 수 있다. 비록 각각의 빛에 대한 연속 유니캐스트 전송으로 동일한 결과를 달성하는 것이 가능하지만, 단일 멀티캐스트는 장치 그룹에 동일한 메시지를 전달하는 더 효율적인 방법이다.
<br><br>
