직비 네트워크 계층 서비스 + 패킷 형식

## 네트워크 계층 데이터 서비스
NWK 계층은 APS 하위계층 프로토콜 데이터 유닛(APDU)의 형태로 APS 하위계층으로부터 전송되어야 하는 데이터를 수신한다. APDU와 NWK 계층 헤더의 조합은 NWK 계층 프로토콜 데이터 유닛(NPDU)을 형성할 것이다. <br>
<br>
APS 하위 계층은 NLDE-DATA.request primary를 사용하여 네트워크에서 다른 디바이스의 APS 하위 계층으로 데이터 전송을 요청한다. 데이터 전송 요청은 데이터가 네트워크에서 반경 매개변수를 사용하여 이동할 수 있는 거리를 제한한다. 그 데이터에는 일련번호가 첨부되어 있다. 시퀀스 번호는 무작위 숫자에서 시작하여 각 데이터 프레임이 전송될 때마다 한 번씩 증가된다. 수신측에서 NWK 계층은 데이터 프레임, LQI 및 데이터 시퀀스를 NLDE-DATA.indication primitive를 사용하여 APS 하위 계층에 전달한다.<br>
<br>

## 네트워크 계층 관리 서비스
NWK 계층의 주된 책무는 네트워크 형성, 네트워크 가입 및 탈퇴, 경로 탐색 및 경로 유지이다.<br>

### 네트워크 탐색
네트워크 탐색 절차는 디바이스 POS에서 현재 동작하는 모든 네트워크를 검색하기 위해 사용된다. 디바이스 탐색 요청은 APL 계층이 NWK 계층에게 보낸다. NWK 계층은 MAC 계층 채널 스캐닝을 사용하여 다른 네트워크의 존재를 발견한다. 엑티브 스캔은 디바이스가 엑티브 스캔을 수행할 수 있는 경우 선호되는 스캔 방법이다. 그렇지 않으면 디바이스는 패시브 스캔을 수행한다. <br>
<br>
네트워크 탐색 동작은 각 네트워크가 사용하는 ZigBee 프로토콜의 버전, PAN 식별자, 현재 주파수 채널, 등 발견된 네트워크 목록을 APL 계층에 전달한다. 또한 이 정보에는 비콘 순서, 네트워크의 슈퍼프레임 순서 및 이들의 지그비 스택 프로파일 식별자의 값도 포함된다. 네트워크 탐색은 현재 가입을 허용하는 탐색된 네트워크에 적어도 하나의 ZigBee 라우터가 있는지 검증할 것이다.<br>
<br>
### 네트워크 형성(formation)
NWK 계층은 APL 계층의 요청을 수신하면 디바이스를 ZigBee 코디네이터로 설정할 수 있다. ZigBee 코디네이터 역할을 하려면 디바이스가 FFD여야 한다. 네트워크 형성의 첫 번째 단계는 MAC 관리 서비스를 사용하여 선택한 개수의 채널에 대해 ED 스캔을 수행한 다음, 엑티브 스캔을 수행하는 것이다. 스캔 요청은 NLME에서 MLME로 발행한다. 스캔 결과를 바탕으로 NWK 계층은 주파수 채널과 고유한 PAN 식별자를 선택한다. 기존 네트워크 수가 가장 적은 첫 번째 채널은 새로운 네트워크에서 이용하기에 적절한 주파수 채널로 간주된다. ZigBee 코디네이터의 NWK 레이어는 네트워크 주소와 동일한 MAC 단축 어드레스로 0x0000을 선택한다. ZigBee 코디네이터의 첫 번째 업무는 MAC 관리 서비스를 이용한 슈퍼프레임을 구성하는 것이다.
<br><br>
### 디바이스를 라우터로 설정
어떤 디바이스에서도 MAC 속성 macAssociationPermit가 TRUE로 설정되어 있으면, 디바이스는 연결 요청을 수락한다. ZigBee 코디네이터나 라우터의 NWK 레이어는 MLME에 macAssociationPermit의 값을 정해진 기간 동안 TRUE로 설정해 달라고 요청함으로써 다른 디바이스가 네트워크에 가입할 수 있도록 할 수 있다. 이 기간은 허가 기간으로 알려져 있다. <br>
<br>
다음 상위 계층은 NLME-JOIN.request primary를 사용하여 NWK 계층을 라우터 또는 엔드 디바이스로 기존 네트워크에 결합하도록 요청할 수 있다. 이 프리미티브은 또한 디바이스가 이전에 이 네트워크와 관련되었는지 여부를 명확하게 한다.<br>
<br>
자식은 스캔의 길이와 유형(엑티브 또는 패시브)을 선택한다. 자식의 MAC 계층은 발견된 네트워크 목록을 NWK 계층에 전달한다. 그리고 자식은 적당한 부모를 고른다. 연계를 허용하고 링크 비용이 3 미만인 부모의 경우, 부모로서 적합하다고 간주한다. 만일 적합한 부모가 1명 이상 있을 경우, ZigBee 코디네이터로부터 가장 낮은 깊이의 부모를 선택해야 한다. 적합한 부모를 선택하면, 자식의 NWK 계층은 MLME-ASSOCIATE.request 프리미티브를 사용하여 연결 절차를 시작한다.<br>
<br>
부모가 연결 요청을 받았을 때, 가입을 요청하는 디바이스가 이미 자식으로서 부모 네트워크에 있는지 여부는 이웃 테이블에서 찾아서 결정한다. 이웃 테이블에서 이 자식이 발견되지 않으면, 자식은 고유한 네트워크 주소를 받게 된다. 각 부모는 자식에게 할당하는 데 사용할 수 있는 주소의 수가 제한되어 있다. 가입 요청이 허가되면, 부모는 이 디바이스를 자신의 자식으로 추가하기 위해 이웃 테이블을 갱신한다.<br>
<br>
디바이스가 이전에 이 부모에 연결된 경우 NWK 재가입 요청 명령(rejoin request command)이 사용된다. 부모가 현재 어떤 새로운 자식을 받아들이지 않더라도 아이는 부모에 다시 들어갈 수 있다.<br>
<br>
네트워크에 가입하는 다른 방법은 직접 가입(direct join)이다. 직접 가입은 부모가 자식의 64비트 주소로 이미 사전 구성되었을 때 사용된다. 이 경우, 부모는 이미 부모로 선택되었기 때문에, 자식은 적합한 부모를 찾으려 하지 않는다. 부모는 자식의 64비트 주소가 이미 표에 기재되어 있는지 확인하기 위해 이웃 테이블을 검색하여 가입을 시작할 것이다. 이웃 테이블에서 일치가 발견되면 부모로부터 추가 조치가 요구되지 않는다. 이웃 테이블에서 주소를 찾을 수 없을 경우, 테이블이 꽉 차지 않을 경우, 부모는 테이블에서 항목을 생성한다.<br>
<br>
직접 연결에서 부모는 자식에게 연락하지 않지만, 자식은 고립 절차을 시작해 자식/부모 관계 구축을 완료할 책임이 있다.<br>
<br>
자식을 네트워크에서 제거하는 것은 자식 자신이나 그 부모에 의해 시작될 수 있다. MAC 계층의 연결 해제는 네트워크에서 장치를 제거하기 위해 사용된다. 어떤 장치가 네트워크를 떠날 때, 그 장치들의 모든 자식들도 네트워크에서 제거될 수 있다. 이 제거된 자식들은 신청 시나리오에 따라 네트워크에 새로운 부모들과 합류하거나 다른 네트워크에 가입할 수 있다.<br>
<br>
네트워크에서 자신을 제거하려는 장치가 ZigBee 코디네이터나 라우터인 경우, NWK 계층 탈퇴 명령(leave command)) 프레임을 목적지 주소로 0xffff의 브로드캐스트 주소를 선택하여 네트워크 전체에 브로드캐스트한다. 이 탈퇴 명령을 브로드캐스트 하는 이유는 특정 라우터나 코디네이터에 의존하는 모든 디바이스가 필요한 경우 경로를 업데이트하거나 새로운 부모를 찾아야 한다는 것을 알 수 있도록 하기 위한 것이다. 반면, ZigBee 엔드 디바이스는 leave 명령을 그것의 부모에만 유니캐스트한다. 두 경우 모두 APL 계층은 NLME-LEAVE.Request를 사용하여 NWK 계층을 요청하면 제거 절차가 시작된다.<br>
<br>
부모가 자식을 제거하기로 결정하면, 그것은 자식에게 탈퇴 요청 명령을 유니캐스트한다. 자식이 네트워크에서 성공적으로 제거된 후, 부모는 이에 따라 이웃 테이블을 업데이트한다. 이전 자식의 주소는 APL 계층이 자식 제거를 위해 NWK 계층에 주어진 NLME-LEAVE.request 프리미티브에서 주소 재사용을 허용하는 경우에만 재사용 할 수 있다. 제거된 자식이 ZigBee 라우터인 경우, 자식은 0xffffff에 해당하는 목적지 주소를 선택하여 leave 명령을 브로드캐스트한다.<br>
<br>
### 네트워크 계층 리셋

![image](https://user-images.githubusercontent.com/38284141/53313861-ba4d7d80-38fe-11e9-8650-251498a7c770.png)
<br>
NWK 레이어는, 다음 상위 레이어의 요청에 따라, 리셋 작업을 실시한다(그림 3.39). NWK 계층은 먼저 MAC 계층을 리셋한다. MAC 리셋 확인을 수신한 후, NWK 레이어는 모든 NIB 속성, 라우팅 테이블, 경로 탐색 테이블을 기본값으로 설정한다. 리셋 요청은 NLME-RESET.request의 형태로 APL 계층에서 온다. NWK 계층은 NLME-RESET.confirm 프리미티브에 의한 리셋 작업의 결과를 APL 계층에 보고한다. 디바이스는 초기 전원 가동 후, 가입을 시도하기 전과 네트워크를 떠난 후에 NWK 계층 리셋을 수행한다.<br>
<br>
### 동기화
![image](https://user-images.githubusercontent.com/38284141/53314031-98a0c600-38ff-11e9-9b19-f22016c9968c.png)
<br>
디바이스는 동기화 절차를 사용하여 ZigBee 코디네이터 또는 라우터로부터 보류 중인 데이터를 동기화하거나 추출할 수 있다. 비컨 활성화와 비컨 비활성화의 두 가지 동기화 시나리오가 있다. 그림 3.40은 두 경우의 시퀀스 차트를 보여준다. macAutoRequest의 값은 MAC에 데이터 요청 명령을 자동으로 생성 및 전송하도록 요청하는 TRUE로 설정된다. APL 계층은 NLME-SYNC.request를 사용하여 NWK 계층에게 요청하여 동기화 및 데이터 요청 프로세스를 시작한다. 동기화 결과는 NLME-SYNC.confirm에 의해 APL 계층에 전달된다.<br>
<br>
<br>

## 네트워크 계층 프레임 형식
NWK 계층 데이터와 명령 프레임 및 그 기능성에 대해 검토한다. 일반적인 NWK 레이어 프레임 포맷부터 데이터와 커맨드 프레임 포맷으로 설명한다.<br>

![image](https://user-images.githubusercontent.com/38284141/53319628-63ec3900-3916-11e9-9aba-9965d9d3733c.png)
<br>
일반적인 NWK 레이어 프레임을 그림 3.41에 나타낸다. 첫 번째 필드는 프레임 컨트롤이다. 프레임 유형은 NWK 데이터 프레임인지, NWK 명령 프레임인지를 결정한다. ZigBee 표준은 시간이 지남에 따라 진화하고 특정 장치에서 사용되는 ZigBee 프로토콜 버전은 nwkcProtocolVersion 에 저장된다. nwkcProtocolVersion의 값은 항상 NWK 프레임의 프로토콜 버전 하위 필드로 복사된다.<br>
<br>
경로탐색 하위 필드는 이 프레임의 라우팅 옵션을 결정한다. 경로탐색 하위필드가 억제 또는 활성화되도록 설정되어 있고 이미 목적지까지 경로가 설정된 경우, 프레임이 다음 홉으로 전송된다. 그러나 목적지까지 경로가 설정되지 않고 경로탐색 하위 필드가 억제되도록 설정된 경우, 디바이스는 새로운 경로 탐색을 시작하지 않는다. 경로를 사용할 수 있게 될 때까지 프레임은 폐기되거나 버퍼링된다. 경로탐색이 활성화되도록 설정되어 있으면, 목적지까지의 경로가 없을 경우 경로 탐색이 개시된다. 마지막으로, 경로탐색을 강제적으로 실시하도록 설정한 경우, 이미 목적지까지 설정된 경로가 있더라도, 이 프레임을 전송하기 위한 경로 탐색이 개시된다. ZigBee-Pro에서는 강제 경로 탐색 옵션이 경로탐색 하위 필드에서 제거됐다.<br>
<br>
멀티캐스트 플래그가 1로 설정되면, 멀티캐스트를 사용하여 프레임이 전송될 것이다. NWK 계층 보안이 활성화된 경우 보안 하위 필드는 1로 설정된다. 프레임 컨트롤의 소스 경로 하위 필드는 소스 경로 서브프레임 필드가 프레임에 포함되는 경우 1로 설정된다. 소스 라우팅은 패킷의 송신자가 패킷이 네트워크를 통과해야 하는 경로를 지정할 수 있는 기술이다. 소스 경로 서브프레임은 소스 라우팅에서 프레임을 중계하는 데 사용될 노드의 16비트 짧은 주소 목록을 포함한다. 릴레이 인덱스는 소스 장치에서 0으로 설정되며 라우터에 의해 프레임이 릴레이될 때마다 증가된다. 릴레이 카운트는 프레임이 릴레이되는 횟수다.<br>
<br>
NWK 계층은 IEEE 주소 하위 필드가 1로 설정된 경우 선택적으로 NWK 계층 프레임에 64비트 IEEE 주소를 포함할 수 있다. 소스와 목적지의 16비트 네트워크 주소는 항상 프레임에 포함되어 있다. 반경 필드는 프레임에 허용되는 최대 홉 수를 결정한다. 반지름 매개변수가 제공되지 않을 경우 NWK 헤더의 반지름 필드는 nwkMaxDepth 속성의 두 배 값으로 설정된다. 시퀀스 번호는 디바이스에 의해 전송된 시퀀스를 추적하는 데 도움이 된다. 시퀀스 번호의 값은 새로운 프레임이 전송될 때마다 증가된다.<br>
<br>
멀티캐스트 제어 필드는 프레임이 멀티캐스트인 경우에만 존재한다. 멀티캐스트 모드 하위 필드는 프레임이 비회원 모드(00과 동일한 멀티캐스트 모드) 또는 멤버 모드(01과 동일한 멀티캐스트 모드)에서 디바이스에 의해 전송되고 있는지 여부를 결정한다. <br>
비회원 반경 하위 필드는 멀티캐스트 프레임이 비회원 디바이스에 의해 재방송되는 횟수를 제한한다. 비회원 반경은 비회원 디바이스에 의해 프레임이 재방송될 때마다 감소된다. 비회원 반경 필드가 0이 되면 프레임은 더 이상 비회원 디바이스에 의해 재방송되지 않는다. 단, 비회원 반경의 내용이 0x07과 같다면 비회원 디바이스에 의해 프레임이 재방송될 수 있는 횟수에 제한이 없다. 회원 디바이스가 프레임을 (재)브로드캐스트할 때마다 최대 비회원 하위 필드의 내용을 비회원 반경 하위 필드로 복사한다.<br>
<br>

![image](https://user-images.githubusercontent.com/38284141/53320514-3fde2700-3919-11e9-841b-1b3d8f9ced61.png)
<br>
데이터와 명령 프레임 형식은 그림 3.42에 나타나 있다. 라우팅 필드는 그림 3.41의 프레임 컨트롤과 NWK 페이로드 사이의 필드 조합이다.<br>
<br>

![image](https://user-images.githubusercontent.com/38284141/53320660-99465600-3919-11e9-822a-9ac728d517a6.png)
<br>
NWK 명령은 표 3.12에 열거되어 있다. 각 명령은 NWK 명령 식별자로 알려진 8비트 번호로 식별된다. NWK 명령 식별자와 명령어는 식별된다. payload는 NWK 프레임 payload를 형성한다.<br>
<br>

![image](https://user-images.githubusercontent.com/38284141/53320729-d9a5d400-3919-11e9-9a92-86f8684485fb.png)
<br>
여기서 NWK 명령을 간략하게 검토한다. ZigBee 2006의 NWK 레이어 명령 페이로드 형식은 그림 3.43과 같다. 첫 번째 명령은 경로 탐색 및 경로 보수 절차에 사용되는 경로 요청 명령이다. 만일 멀티캐스트 서브필드가 1로 설정되어 있다면, 이 경로 요청은 멀티캐스트 경로 탐색의 일부다. 경로 보수 하위 필드는 이 경로 요청 명령을 경로탐색 대신 경로보수로 식별하기 위해 1로 설정된다.<br>
<br>
경로탐색과 경로보수를 구별하는 이유는 경로 탐색이 항상 소스 디바이스에 의해 시작되기 때문이다. 이와는 대조적으로, 경로 수리는 소스 디바이스를 대신하여 메시지를 전달하려고 시도했지만 다음 홉으로 프레임을 보내려고 시도하는 동안 링크 실패에 직면했던 라우터 디바이스에 의해 시작된다. 경로 요청 식별자는 소스 디바이스에서 발급한 각 경로 요청을 식별하는 데 사용되는 8비트 시퀀스 번호다. 소스 디바이스는 새로운 경로 요청을 생성할 때마다 경로 요청 식별자 필드의 내용을 증가시킨다. 경로 탐색 중에, 소스 디바이스를 대신하여 경로 요청을 브로드캐스트하는 라우터는 경로 요청 식별자를 변경하지 않고 유지한다. 경로 탐색의 목적은 경로 요청 명령 프레임에 제공된 목적지 주소에 대한 경로를 찾는 것이다.<br>
<br>
경로 요청 명령은 소스 디바이스에서 대상 디바이스로 경로 비용을 축적하기 위한 경로 비용 필드를 가진다. 경로 비용 필드는 소스에서 목적지까지의 최적 경로를 결정하는 데 이용될 것이다. 목적지 디바이스는 여러 경로에서 동일한 경로 요청 프레임을 수신할 수 있다. 목적지 장치는 소스 장치로 가장 좋은 경로로 회신할 것이다.<br>
<br>
ZigBee-Pro에서는 경로 요청 명령의 경로 비용 필드 뒤에 목적지 IEEE 주소가 하나 더 있다. 또, ZigBee-Pro 비트에서는, 다대일 경로 요청을 지원하기 위해, 제출된 명령 옵션 3-4를 이용한다. 비트 2-3의 값이 0과 같을 경우, 경로 요청이 다대일 경로 요청이 아니라는 것을 의미한다. 값이 1과 같을 경우, 경로 요청은 다대일이며, 송신자는 경로 기록테이블을 지원한다. 마지막으로, 명령 옵션 필드에서 비트 2-3의 값이 2인 경우, 경로 요청은 다대일이고 송신자는 경로 기록테이블을 지원하지 않는다.<br>
<br>
다음 NWK 레이어 명령은 경로 응답 명령으로, 경로 요청 명령에 응답하여 목적지 디바이스에서 소스 디바이스로 전송된다. 명령 옵션 필드는 경로 요청 명령의 명령 옵션 필드와 유사하다. 경로 요청 식별자는 경로 요청 명령 프레임과 동일하다. 이 방법으로, 소스 디바이스가 목적지 디바이스로부터 경로 응답 명령을 수신할 때, 소스 디바이스의 경로 요청 중 하나에 대한 응답으로 이 경로 응답 명령이 주어지는 것을 소스 디바이스가 알게 된다. 발신자 주소 필드에는 경로 요청을 발신한 디바이스(소스 디바이스)의 16비트 주소가 포함되어 있다. 응답자 주소 필드는 경로 요청 명령 목적지 주소에 제공된 16비트 NWK 주소를 포함한다. 소스 디바이스는 항상 응답기 디바이스에 대한 경로를 설정하려고 시도한다. 경로응답명령의 경로비용은 응답디바이스(목적지 디바이스)에서 개시디바이스(소스 디바이스)까지 총경로비용을 축적하기 위해 사용된다. ZigBee-Pro에서는 경로 비용 필드 다음에 발신자 IEEE 주소와 응답자 IEEE 주소 두 개의 필드가 추가되어 있다.<br>
<br>
route error 명령은 특정 목적지 주소로 프레임을 릴레이하는 동안 발생한 오류를 소스 디바이스에 알리기 위해 사용된다. 오류 코드 필드에 제공된 오류 코드를 사용하여 라우팅 오류의 원인을 결정할 수 있다. 라우팅 오류의 예로는 트리 링크 고장, 라우팅 용량 부족, 배터리 부족 등이 있다. 후자에서, 중계 장치는 배터리 잔량이 매우 낮기 때문에 라우터 역할을 할 수 없다. ZigBee-Pro에서 이 명령은 Network Status Command로 이름이 바뀌며 오류 코드를 상태 코드라고 한다. ZigBee-Pro의 네트워크 상태 명령은 경로 오류 명령의 모든 오류 코드와 PAN 식별자 업데이트와 같은 사고를 보고하기 위한 추가 코드를 포함하고 있다.<br>
<br>
디바이스는 디바이스 자체가 네트워크를 떠날 의도일 때 또는 디바이스가 다른 디바이스에게 네트워크에서 나가도록 요청하고 있을 때 leave 명령을 전송한다. 디바이스 자체가 네트워크를 빠져나가는 경우, leave 명령의 요청 하위 필드는 0으로 설정된다. 그렇지 않으면 요청 하위 필드가 1로 설정되어 이 명령의 송신자가 명령 수신자에게 네트워크에서 나가도록 요청하고 있음을 나타낸다. 디바이스는 부모를 떠나 네트워크의 다른 디바이스에 다시 가입할 수 있다. 디바이스가 네트워크에 다시 가입하려고 하는 경우, leave 명령의 재결합 하위 필드는 1로 설정된다. 마지막으로, 네트워크를 떠나는 디바이스가 부모이고 명령의 자식 제거 서브필드가 1로 설정된 경우, 부모가 떠날 때 이 부모의 모든 자식이 네트워크에서 제거된다.<br>
<br>
경로 기록 명령은 설정된 경로를 따라 이 명령 프레임을 목적지에 전달하는 모든 디바이스의 주소를 기록하기 위해 전송된다. 릴레이 카운트 하위필드 값은 프레임이 중계된 횟수와 동일하다. 이 프레임을 중계한 모든 디바이스의 짧은 주소는 중계 목록에 보관된다. 목적지 디바이스 이외의 디바이스가 이 명령을 수신하면, 16비트 짧은 주소를 릴레이 목록에 추가하고 릴레이 카운트를 증가시킨 후 유니캐스트를 통해 다음 홉으로 전송한다. 다음 홉의 주소는 라우팅 테이블에 제공된다.<br>
<br>
예를 들어 자식이 부모와 더 이상 통신할 수 없는 경우, 디바이스는 원래 부모 이외의 장치를 통해 네트워크에 다시 가입하는 재가입 요청 명령을 사용할 수 있다. 다시 가입 요청 명령에서 장치는 기능 목록을 제공한다. 이는 MAC 계층 연결 요청에서 제공하는 기능 목록과 유사하다. 재가입 요청을 수신하는 디바이스는 재가입 응답 명령을 사용하여 응답한다. 새 부모가 새 자식를 받아들일 용량이 있는 경우, 재가입 응답 명령의 짧은 주소 필드는 자식에게 할당된 새 16비트 주소를 포함한다. 재가입 상태 필드는 그림 3.25 의 연계 상태 필드와 유사하다.<br>
<br>
ZigBee-Pro의 NWK 계층에는 ZigBee-2006에서는 사용할 수 없는 3개의 추가 명령이 있다. 첫번째는 Link Status 명령이다. 각 라우터는 링크 상태 명령을 사용하여 링크 비용을 다른 인접 라우터에 전달할 수 있다. 두 번째 명령은 nwkManagerAddr의 지정된 장치에 PAN ID 충돌 및 채널 상태 등의 네트워크 이벤트를 보고하는 데 사용되는 Network Report Command. 마지막 명령은 Network Update Command이다. 이 명령은  구성 변경을 위해 지정된 디바이스(nwkManagerAddr 속성으로 식별)에 의해 사용된다.

