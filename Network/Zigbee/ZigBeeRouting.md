## 라우팅 
라우팅은 메시지가 목적지 디바이스로 전달될 경로를 선택하는 과정이다. ZigBee 코디네이터와 라우터는 네트워크에서 경로를 발견하고 유지해야 한다. ZigBee 엔드 디바이스는 경로 검색을 수행할 수 없으며, ZigBee 코디네이터 또는 라우터는 엔드 디바이스를 대신하여 경로 검색을 수행한다.
<br>
경로의 길이(L)는 경로의 디바이스 수로 정의되어 있다. 그림 3.36은 길이 5(L5), 길이 7(L7)의 2개 경로의 예를 보여주고 있다. 한 경로에서 두 개의 연속적인 디바이스들 사이의 연결은 링크라고 불린다. 링크는 그림 3.36에 L1부터 L4까지 번호가 매겨진다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53296883-29bc6200-3858-11e9-89d4-628a14b7964f.png)
<br>
링크 품질, 홉 수 및 에너지 절약 고려사항과 같은 매개변수를 사용하여 각 라우팅 시나리오에 대한 최적의 경로를 결정할 수 있다. 이 과정을 단순화하기 위해서, 각 링크는 링크 비용과 연관되어 있다. 각 링크에서의 패킷 전달의 성공 확률은 링크 비용을 결정할 것이다. 패킷 전송 성공 확률이 낮을수록 링크 비용은 높아진다. 각 링크의 비용은 그림 3.36에서 C{[Di,D+i]}으로 표시된다.<br>
<br>
링크 비용을 결정하는 다양한 방법이 있다. 직비 표준은 다음과 같은 방정식을 사용한다.<br>
![image](https://user-images.githubusercontent.com/38284141/53296921-37261c00-3859-11e9-93f3-0e5bc039bab0.png)
<br>
C {L}은 링크 L의 비용이다. 링크 L에서의 패킷 전달 성공 확률은 PL로 나타낸다. round 함수는 숫자를 가장 가까운 정수 값으로 반올림한다. 비용은 항상 0에서 7사이의 정수다. 예를 들어 PL이 80%이면 링크 비용은 정수 2가 된다.
![image](https://user-images.githubusercontent.com/38284141/53296941-06de7d80-3859-11e9-99ea-155a0aff2a1b.png)
<br>
패킷 전송 성공 확률(PL)은 다양한 방법을 사용하여 추정할 수 있으며, ZigBee 표준은 구현자가 자신의 애플리케이션에 가장 적합한 방법을 선택할 수 있도록 한다. 단, 패킷의 성공적인 전달 가능성에 대한 초기 추정치는 평균 LQI에 근거해야 한다. LQI는 수신된 각 패킷에 대해 기록되며, 신호 에너지나 SNR을 조사한다. 일반적으로, LQI가 증가함에 따라 패킷의 성공적인 수신 가능성은 증가한다. 링크 비용을 계산하는 간단한 방법은 룩업 테이블을 사용하여 LQI의 다른 레벨을 0~7의 링크 비용 수준에 직접 매핑하는 것이다. 이 표는 보통 몇 가지 실험의 평균 결과를 바탕으로 만들어진다.<br>
<br>
다른 경로를 비교하기 위해, 각 경로는 경로 비용과 연관된다. 경로 비용(C{P})은 단순히 경로를 구성하는 링크의 비용을 합산한 것이다.<br>
![image](https://user-images.githubusercontent.com/38284141/53297833-9c810980-3867-11e9-9f0e-920b5713df4c.png)
<br>
경로 비용이 가장 저렴한 노선은 패킷의 성공적인 전달을 위한 최선의 기회를 갖게 될 것이다. <br>
ZigBee 코디네이터와 라우터는 라우팅 테이블을 생성하고 유지한다(표 3.9). <br>
![image](https://user-images.githubusercontent.com/38284141/53297846-d6521000-3867-11e9-9a74-da4956b46496.png)
<br>
라우팅 테이블은 메시지를 특정 목적지로 라우팅할 때 다음 홉을 결정하기 위해 사용된다. 상태 필드는 경로의 상태를 결정한다. 라우팅 테이블 용량이라는 용어는 장치가 라우팅 테이블을 사용하여 특정 목적지 주소로 경로를 설정할 수 있음을 의미한다.<br>
<br>
라우팅과 관련된 또 다른 표는 새로운 경로 탐색 중에 사용되는 경로 탐색 테이블이다(표 3.10). <br>

![image](https://user-images.githubusercontent.com/38284141/53297887-8293f680-3868-11e9-8568-5b5d89c52a8f.png)
<br>
경로 탐색표에는 경로 비용, 경로를 요청한 장치(소스 장치)의 주소, 현재 장치에 요청을 전달한 마지막 장치의 주소가 수록되어 있다. 후자는 경로 발견 결과를 경로 요청 발신자(소스 장치)로 다시 전송하는 데 사용된다.<br>
<br>
라우팅 테이블과 대조적으로 경로 검색 테이블의 내용은 일시적이며 nwkcRouteDiscoveryTime 밀리초 후에 만료된다. <br>
<br>

![image](https://user-images.githubusercontent.com/38284141/53298111-069bad80-386c-11e9-92cd-ab96177f4e18.png)

<br>
ZigBee 네트워크의 장치는 또한 송신 범위의 디바이스에 대한 정보를 포함하는 이웃 테이블을 유지한다 (표 3.11). 이 표는 디바이스가 이웃들 중 한 명으로부터 패킷을 받을 때마다 업데이트된다. 인접 테이블은 디바이스가 근처의 라우터를 찾거나 네트워크에 다시 가입해야 할 때 유용하다. 디바이스는 또한 새로운 부모를 찾을 때 이웃 테이블을 사용한다. 표 3.11에는 모든 필수 필드 및 일부 선택 필드가 포함된다.
<br>
트리 네트워크의 라우팅 메커니즘을 계층적 라우팅이라고 한다. nwkUseTreeRouting 속성이 TRUE로 설정되면, 장치는 계층적 라우팅을 사용할 수 있다.
<br>
### 경로 탐색
APL 계층은 NLME-ROUTE-DISCOVERY.request primary를 사용하여 NWK 계층이 유니캐스트, 멀티캐스트 및 다대일 통신을 위한 경로를 검색하도록 요청할 수 있다. 경로 탐색 요청이 개별 디바이스의 주소를 목적지 주소로 포함하는 경우, NWK 계층은 유니캐스트 경로 검색을 수행한다. 유니캐스트 경로는 항상 단일 소스 주소에서 시작하여 단일 목적지 주소에서 끝난다. 멀티캐스트 경로 발견은 목적지 주소가 멀티캐스트 그룹의 16비트 그룹 ID이면 시작될 것이다. 마지막으로, APL 계층이 목적지 주소를 제공하지 않는 경우, NWK 계층은 APL 계층이 다대일 경로 검색을 요청했다고 가정한다. 다대일 경로는 경로 발견을 요청한 장치를 싱크(sink) 장치로 배치한다.<br>
ZigBee 코디네이터와 라우터만이 경로 탐색 요청을 수행할 수 있다. 또한, 지그비 표준은 브로드캐스팅을 위한 경로 발견을 허용하지 않는다. 따라서 APL 계층이 NLME-ROUTE-DISCOVERY.request primary를 브로드캐스트 주소(0xffff)와 동일한 목적지 주소로 NWK 계층에 발급하는 경우, 프리미티브는 무효한 요청으로 처리된다.<br><br>

![image](https://user-images.githubusercontent.com/38284141/53298205-e2d96700-386d-11e9-98b9-fa1d54114610.png)
<br>
그림 3.37은 유니캐스트 경로 탐색의 예를 보여주고 있다. 이 시나리오에서 디바이스 A는 디바이스 F로 가는 경로를 찾으려 한다. 디바이스 A는 경로 요청 명령을 방송하여 경로 검색을 시작한다. 경로 요청 명령 프레임에는 경로 요청 식별자, 목적지 주소 및 경로 비용 필드가 포함되어 있다. 경로 요청 식별자는 경로 요청에 대한 8비트 시퀀스 번호로, NWK 계층이 경로 요청을 발행할 때마다 1씩 증가한다. 경로 비용 필드는 각 경로의 총경로 비용을 축적하는 데 이용된다. 디바이스 A는 경로 요청 명령을 브로드캐스팅하기 전에 경로 비용 필드의 값을 0으로 설정한다. <br>
<br>
브로드캐스트 명령은 디바이스 A의 무선 범위에 있으며, 동일한 주파수 채널을 청취하는 모든 장치에서 수신된다. 그림 3.37에서 디바이스 B와 디바이스 C는 경로 요청 명령을 수신한다. 디바이스 A는 수동적 확인응답을 기다리며, 브로드캐스트가 성공하지 못한 경우, 초기 브로드캐스트 후 nwkcInitialRREQRetries 시간 동안 브로드캐스트를 재시도한다. 이러한 재시도들은 nwkcRREQRetryInterval 밀리초 단위로 구분된다. <br>
<br>
경로 요청 명령을 수신한 장치가 ZigBee 엔드 디바이스라면, 라우팅 기능이 없기 때문에 경로 요청 명령을 무시할 것이다. 간략히 그림 3.37은 디바이스 A와 디바이스 F 사이에 위치한 디바이스만 표시하며, 디바이스들은 ZigBee 코디네이터나 ZigBee 라우터 중 하나이다. Device B는 ZigBee 라우터로, B에 라우팅 용량이 있으면(라우팅 테이블이 꽉 차 있지 않은 경우), 라우팅 요청 명령의 경로 비용 필드에 장치 A에서 장치 B까지 경로 비용을 추가하고, 경로 요청 명령을 브로드캐스트한다. 디바이스 B의 경로 검색 테이블에 이 경로 요청 식별자와 소스 주소(디바이스 A 주소)가 없는 경우, 디바이스 B는 이에 따라 경로 검색 표를 업데이트한다.<br>
<br>

<br>
디바이스 B 라우팅 테이블이 가득 차 있고 대상 주소가 라우팅 테이블에 없는 경우, 네트워크가 계층적 라우팅을 기반으로 하고 있으며, 유효한 경로에서 경로 요청 명령이 수신된다고 가정하면, 디바이스 B는 트리를 따라 경로 요청 명령을 유니캐스트한다. 그러나 디바이스 B의 라우팅 테이블이 가득 차 있고 유효한 경로를 따라 경로 요청이 수신되지 않은 경우, 디바이스 B는 경로 요청 명령을 무시한다. <br>
<br>
디바이스 C도 ZigBee 라우터이고 그것이 경로 요청 명령을 수신할 때 장치 B와 유사하게 작용한다. 디바이스 B와 C의 브로드캐스트는 그림 3.37의 디바이스 D와 E에 도달할 수 있다. 디바이스 D와 E는 라우팅 용량을 가지고 있다고 가정하여 경로 요청을 다시 방송한다. 다른 브로드캐스트와 마찬가지로 각 디바이스는 무작위 지연(브로드캐스트 지터)으로 브로드캐스팅을 시작한다. 경로 발견 시, 이 지연은 2 x nwkcMinRREQJitter와 2 x nwkcMaxRREQJitter 사이의 임의의 번호다. <br>
<br>
예를 들어 Device D는 다른 릴레이 장치로부터 동일한 경로 요청 명령(디바이스 A에서 시작된)을 수신할 수 있다. Device D는 전송 디바이스에서 장치 D로 가는 가장 낮은 경로 비용을 포함하도록 경로 검색 표를 업데이트해야 한다. 이것은 디바이스 A를 향한 경로 탐색의 결과를 통신할 때 장치 D에 도움이 될 것이다. 그 때, 장치 D는 장치 A에 대한 가장 낮은 경로 비용을 기초로 경로 탐색표에서 그 다음 홉을 선택하기만 하면 된다. <br>
<br>
연이은 브로드캐스트는 의도한 목적지(디바이스 F)에 의해 경로 요청 명령이 수신될 때까지 반복된다. 디바이스 F는 디바이스 A에서 디바이스 F까지의 최적 경로를 선택하기 위해 수신된 각 경로 요청 명령의 전체 누적 경로 비용을 사용한다. 디바이스 F는 디바이스 A에 경로 응답 명령을 다시 전송하기 위한 다음 홉으로 D 또는 E 중 하나를 선택한다. 예를 들어 D가 다음 홉인 경우, D는 경로 검색 표를 사용하여 경로 응답 명령을 A에 다시 중계하는 다음 홉을 찾는다.<br><br>

A(소스 디바이스)에서 F(목적지 디바이스)로 가는 경로를 전진 경로라고 한다. F에서 A로 가는 경로는 후진 경로로 간주된다. 그 경로는 대칭이거나 비대칭이 될 수 있다. 대칭 라우팅을 선택하면 nwkSymLink를 TRUE로 설정하여 전진 및 후진 경로가 동일하다. 즉, 그림 3.37에서 메시지는 A에서 F로 메시지를 전달하는 데 사용한 디바이스와 동일한 디바이스를 사용하여 F에서 A로 다시 전달된다. nwkSymLink의 값을 FALSE로 설정하면 장치 F는 장치 A로 가는 경로를 찾기 위해 별도의 경로 검색이 필요하다. <br>
<Br>
유니캐스트 경로 발견과 유사한 멀티캐스트 경로 발견은 소스 디바이스(initiating device)가 경로 요청 명령을 브로드캐스트하면서 시작한다. 소스 디바이스는 경로 검색이 진행 중이라는 사실을 반영하도록 라우팅 테이블을 만들거나 기존 테이블을 업데이트한다. 이 브로드캐스트를 수신하고 라우팅 용량을 가진 어떤 디바이스도 해당 디바이스가 요청된 멀티캐스트 그룹의 멤버인지 여부를 알기 위해 브로드캐스트 프레임에 의해 제공된 멀티캐스트 그룹 ID와 그것의 멀티캐스트 테이블의 그룹 ID를 비교할 것이다. 만약 수신 디바이스가 요청된 멀티캐스트 그룹의 멤버가 아니라면, 그것은 이 멀티캐스트 경로 탐색을 유니캐스트 경로 탐색과 유사하게 취급할 것이다. 그러나 수신처 주소는 멀티캐스트 그룹 ID로 설정된다.<br>
<br>
수신인 장치가 요청된 멀티캐스트 그룹의 멤버라면, 그것은 이 새로운 경로 탐색 요청을 위해 경로 탐색 테이블을 만들거나 업데이트 할 것이다. 만약 이 멤버 디바이스가 이미 소스 디바이스 주소와 동일한 경로 요청 식별자에 해당하는 경로 검색 테이블에 항목을 가지고 있다면, 멤버 디바이스는 가장 낮은 경로 비용을 가진 경로를 유지한다. 멤버 디바이스는 유니캐스트 경로 탐색과 유사한 경로 신뢰 명령을 소스 디바이스로 전송한다.<br><br>

### 소스 라우팅
ZigBee NWK 계층은 소스 라우팅의 사용을 허용한다. 소스 라우팅 메커니즘에서 프레임을 만든 측은 중계 역할을 하는 모든 디바이스의 목록을 생성하고 이를 NWK 프레임 자체에 포함한다. 이 방법으로, 라우팅 디바이스가 이 프레임을 수신할 때, 프레임에 포함된 중계 목록에서 다음 노드의 주소를 간단히 찾는다. 이 릴레이 목록에는 인덱스가 항상 다음 홉의 주소를 가리키도록 프레임이 릴레이될 때마다 증가되는 인덱스가 있다. 즉, 소스 라우팅에서는 프레임을 중계하는 디바이스가 자체 라우팅 테이블 대신 릴레이 목록에서 다음 홉 주소를 조회한다.<br>
<br>

## 경로 유지와 보수
메시지를 전달하기 위한 경로가 탐색되어 한동안 이용된 후, 목적지에 메시지를 전달할 수 없는 사고가 발생할 수 있다. 그 이유는 네트워크 자체(예: 라우터가 제거되었거나 꺼져 있는 경우) 또는 환경(예: 물체가 두 노드 간의 무선 연결을 차단하고 있는 경우)에 있을 수 있다. 경로의 생성이나 보수에 필요한 노력을 고려할 때, 경로의 메시지 전달에 실패하는 즉시 경로 보수 절차에 착수하는 것은 권장되지 않는다. 그 대신 링크 고장으로 인해 프레임의 전송실패 횟수만큼 카운터를 유지하는 것이 좋다. 이 카운터가 nwkcRepairThreshold를 초과하면 경로 보수 절차가 시작된다. 링크 실패 시간을 기록할 수도 있다. 이것은 일시적인 연결 고장과 영구적인 연결 고장의 구별에 도움이 될 것이다. 응용 프로그램 개발자는 사용 사례 시나리오에 근거하여 경로 수리를 시작하기 위한 최선의 방법을 결정할 것이다.<br>
<br>
경로 오류가 다대일 토폴로지에서 발생한 경우 링크 고장에 직면한 디바이스는 경로 오류 명령 프레임을 임의의 이웃에 전송한다. 모든 이웃들은 sink(목적지) 디바이스로 가는 라우팅 테이블을 가질 것으로 예상된다. 그런 다음 이웃은 경로 오류 명령 프레임을 싱크 디바이스로 전달한다.<br>

![image](https://user-images.githubusercontent.com/38284141/53298626-fbe51680-3873-11e9-9d18-a0c44f2d2557.png)
<br>
그림 3.38은 메쉬 네트워크에서의 경로 수리의 예를 보여주고 있다. A와 B의 연계가 실패하여 경로 수리가 필요하다. 경로 보수 절차는 원래 소스 디바이스 대신 A가 경로 탐색을 시작한다는 점을 제외하면 경로 탐색과 유사하다. A는 경로 요청 명령 프레임을 방송할 때 자신의 주소를 소스 디바이스로 사용하여 목적지 장치로 새 경로를 찾는다. 경로 보수와 경로 탐색 모두 경로 요청 명령을 사용한다. 경로 보수와 경로 탐색을 구별하기 위해, 경로 요청 명령 프레임의 경로 보수 비트 하위 필드는 1로 설정한다.<br>
<br>
그림 3.38에서, 연속적인 경로 요청 브로드캐스트 후에, 소스와 목적지 주소 사이에 새로운 경로가 설정되었다. 도중에, 새로운 경로는 원래의 경로와 일부 장치를 공유할 수 있다. 어떤 이유로든 A가 목적지에 대한 새로운 경로를 설정할 수 없는 경우, 경로 오류 명령 프레임을 소스 디바이스에 다시 유니캐스트한다. 이 경우, 소스 디바이스는 목적지 주소에 대한 경로를 설정하기 위해 경로 수리 대신 새로운 경로 탐색을 시작해야 한다.
<br>
