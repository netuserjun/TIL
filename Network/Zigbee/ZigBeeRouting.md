## 라우팅 
라우팅은 메시지가 목적지 디바이스로 전달될 경로를 선택하는 과정이다. ZigBee 코디네이터와 라우터는 네트워크에서 경로를 발견하고 유지해야 한다. ZigBee 엔드 디바이스는 경로 검색을 수행할 수 없으며, ZigBee 코디네이터 또는 라우터는 엔드 디바이스를 대신하여 경로 검색을 수행한다.
<br>
경로의 길이(L)는 경로의 디바이스 수로 정의되어 있다. 그림 3.36은 길이 5(L5), 길이 7(L7)의 2개 경로의 예를 보여주고 있다. 한 경로에서 두 개의 연속적인 디바이스들 사이의 연결은 링크라고 불린다. 링크는 그림 3.36에 L1부터 L4까지 번호가 매겨진다.
<br><br>
![image](https://user-images.githubusercontent.com/38284141/53296883-29bc6200-3858-11e9-89d4-628a14b7964f.png)
<br>
링크 품질, 홉 수 및 에너지 절약 고려사항과 같은 매개변수를 사용하여 각 라우팅 시나리오에 대한 최적의 경로를 결정할 수 있다. 이 과정을 단순화하기 위해서, 각 링크는 링크 비용과 연관되어 있다. 각 링크에서의 패킷 전달의 성공 확률은 링크 비용을 결정할 것이다. 패킷 전송 성공 확률이 낮을수록 링크 비용은 높아진다. 각 링크의 비용은 그림 3.36에서 C{[Di,D+i]}으로 표시된다.<br>
<br>
링크 비용을 결정하는 다양한 방법이 있다. 직비 표준은 다음과 같은 방정식을 사용한다.<br>
![image](https://user-images.githubusercontent.com/38284141/53296921-37261c00-3859-11e9-93f3-0e5bc039bab0.png)
<br>
C {L}은 링크 L의 비용이다. 링크 L에서의 패킷 전달 성공 확률은 PL로 나타낸다. round 함수는 숫자를 가장 가까운 정수 값으로 반올림한다. 비용은 항상 0에서 7사이의 정수다. 예를 들어 PL이 80%이면 링크 비용은 정수 2가 된다.
![image](https://user-images.githubusercontent.com/38284141/53296941-06de7d80-3859-11e9-99ea-155a0aff2a1b.png)
<br>
패킷 전송 성공 확률(PL)은 다양한 방법을 사용하여 추정할 수 있으며, ZigBee 표준은 구현자가 자신의 애플리케이션에 가장 적합한 방법을 선택할 수 있도록 한다. 단, 패킷의 성공적인 전달 가능성에 대한 초기 추정치는 평균 LQI에 근거해야 한다. LQI는 수신된 각 패킷에 대해 기록되며, 신호 에너지나 SNR을 조사한다. 일반적으로, LQI가 증가함에 따라 패킷의 성공적인 수신 가능성은 증가한다. 링크 비용을 계산하는 간단한 방법은 룩업 테이블을 사용하여 LQI의 다른 레벨을 0~7의 링크 비용 수준에 직접 매핑하는 것이다. 이 표는 보통 몇 가지 실험의 평균 결과를 바탕으로 만들어진다.<br>
<br>
다른 경로를 비교하기 위해, 각 경로는 경로 비용과 연관된다. 경로 비용(C{P})은 단순히 경로를 구성하는 링크의 비용을 합산한 것이다.<br>
![image](https://user-images.githubusercontent.com/38284141/53297833-9c810980-3867-11e9-9f0e-920b5713df4c.png)
<br>
경로 비용이 가장 저렴한 노선은 패킷의 성공적인 전달을 위한 최선의 기회를 갖게 될 것이다. <br>
ZigBee 코디네이터와 라우터는 라우팅 테이블을 생성하고 유지한다(표 3.9). <br>
![image](https://user-images.githubusercontent.com/38284141/53297846-d6521000-3867-11e9-9a74-da4956b46496.png)
<br>
라우팅 테이블은 메시지를 특정 목적지로 라우팅할 때 다음 홉을 결정하기 위해 사용된다. 상태 필드는 경로의 상태를 결정한다. 라우팅 테이블 용량이라는 용어는 장치가 라우팅 테이블을 사용하여 특정 목적지 주소로 경로를 설정할 수 있음을 의미한다.<br>
<br>
라우팅과 관련된 또 다른 표는 새로운 경로 탐색 중에 사용되는 경로 탐색 테이블이다(표 3.10). <br>

![image](https://user-images.githubusercontent.com/38284141/53297887-8293f680-3868-11e9-8568-5b5d89c52a8f.png)
<br>
경로 탐색표에는 경로 비용, 경로를 요청한 장치(소스 장치)의 주소, 현재 장치에 요청을 전달한 마지막 장치의 주소가 수록되어 있다. 후자는 경로 발견 결과를 경로 요청 발신자(소스 장치)로 다시 전송하는 데 사용된다.<br>
<br>
라우팅 테이블과 대조적으로 경로 검색 테이블의 내용은 일시적이며 nwkcRouteDiscoveryTime 밀리초 후에 만료된다. <br>
<br>

![image](https://user-images.githubusercontent.com/38284141/53298111-069bad80-386c-11e9-92cd-ab96177f4e18.png)

<br>
ZigBee 네트워크의 장치는 또한 송신 범위의 디바이스에 대한 정보를 포함하는 이웃 테이블을 유지한다 (표 3.11). 이 표는 디바이스가 이웃들 중 한 명으로부터 패킷을 받을 때마다 업데이트된다. 인접 테이블은 디바이스가 근처의 라우터를 찾거나 네트워크에 다시 가입해야 할 때 유용하다. 디바이스는 또한 새로운 부모를 찾을 때 이웃 테이블을 사용한다. 표 3.11에는 모든 필수 필드 및 일부 선택 필드가 포함된다.
<br>
트리 네트워크의 라우팅 메커니즘을 계층적 라우팅이라고 한다. nwkUseTreeRouting 속성이 TRUE로 설정되면, 장치는 계층적 라우팅을 사용할 수 있다.
<br>
### 경로 탐색
APL 계층은 NLME-ROUTE-DISCOVERY.request primary를 사용하여 NWK 계층이 유니캐스트, 멀티캐스트 및 다대일 통신을 위한 경로를 검색하도록 요청할 수 있다. 경로 탐색 요청이 개별 디바이스의 주소를 목적지 주소로 포함하는 경우, NWK 계층은 유니캐스트 경로 검색을 수행한다. 유니캐스트 경로는 항상 단일 소스 주소에서 시작하여 단일 목적지 주소에서 끝난다. 멀티캐스트 경로 발견은 목적지 주소가 멀티캐스트 그룹의 16비트 그룹 ID이면 시작될 것이다. 마지막으로, APL 계층이 목적지 주소를 제공하지 않는 경우, NWK 계층은 APL 계층이 다대일 경로 검색을 요청했다고 가정한다. 다대일 경로는 경로 발견을 요청한 장치를 싱크(sink) 장치로 배치한다.<br>
ZigBee 코디네이터와 라우터만이 경로 탐색 요청을 수행할 수 있다. 또한, 지그비 표준은 브로드캐스팅을 위한 경로 발견을 허용하지 않는다. 따라서 APL 계층이 NLME-ROUTE-DISCOVERY.request primary를 브로드캐스트 주소(0xffff)와 동일한 목적지 주소로 NWK 계층에 발급하는 경우, 프리미티브는 무효한 요청으로 처리된다.<br>
<br>
