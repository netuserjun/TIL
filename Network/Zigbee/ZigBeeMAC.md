## 직비 MAC 계층

맥 계층은 물리층과 맥층 위의 상위 계층 사이에서 인터페이스를 제공한다. 직비 무선 네트워크에서, 이 다음 상위 계층은 네트워크 층이다. IEEE 802.15.4는 직비만을 위해서 개발된 게 아니다. 그리고 다음 상위 계층은 어떤 프로토콜 계층이라도 될 수 있다.<br>

맥 층은 물리층과 비슷하게 하위 계층에 MLME(MAC Layer Management Entity)라고 부르는 MAC 관리 서비스가 있다. MLME는 네트워크층의 대응되는 것(NLME)과 상호작용을 한다.<br>
맥층은 또한 그것만의 데이터베이스(MAC-PIB라고 참조되는)를 갖고 있다. 모든 맥 구성요소는 a라는 접두어를 갖는다. 맥 속성들은 mac이라는 접두어를 가진다. MAC-PIB의 크기는 PHY-PIB보다 크다. 맥층 구성요소들과 속성들의 테이블은 표준 문서에 포함되어 있다.<br>

###  Beacon-Enabled 동작과 수퍼프레임 구조
비콘 네트워크의 이점 중 하나는 GTSs(Guaranteed Time Slots)의 가용성이다. 비콘 프레임은 비콘과 GTSs의 번호 사이의 시간 간격같은 비콘 정보를 담은 맥 프레임이다. 비콘 포멧은 뒤에서 다시 다룬다.<br>

슈퍼프레임 그림!!!!!!!!!!!!!!!!!!

Beacon-Enabled 동작에서 슈퍼프레임 구조를 사용할 수 있다. 슈퍼프레임은 위 그림처럼 두 개의 비콘 프레임에 의해 묶여있다. 표준문서에서 슈퍼프레임 구조의 사용은 선택적이다. 수퍼프레임은 세 개의 기간(CAP,CFP,inactive period)이 있을 수 있다.

#### contention access period
CAP동안 전송을 하고 싶은 모든 디바이스들은 주파수 채널 접근을 위해 CSMA-CA 메카니즘을 사용해야 한다. 주파수 채널은 같은 네트워크의 모든 디바이스들이 동등하게 사용할 수 있다. 가용 채널의 사용을 시작한 첫 디바이스는 현재의 전송이 완료될 때 까지 그걸 점유한다. 만약 디바이스가 채널이 바쁨을 감지하면 그것은 랜덤기간동안 기다리고 다시 시도한다. 커다란 네트워크 안에서 이것은 대부분의 장치에 대한 채널 접근의 가장 가능성 있는 메커니즘이다. 맥 명령 프레임들은 반드시 CAP기간동안에 전송되어야 한다.
 
#### contention-free period
CAP기간동안에는 어떤 디바이스든 자기가 원할 때 주파수 채널을 사용할 수 있다는 보장이 없다. CFP는 대조적으로 특정 디바이스에게 타임슬롯을 보장한다. 그러므로 디바이스는 CSMA-CA를 채널 접근할 때 사용할 필요가 없다. 이것은 낮은 지연시간을 가지고, 채널이 사용가능해질때까지 랜덤하고 긴 기간동안 기다릴 여유가 없는 디바이스의 어플리케이션들에게 훌륭한 선택지다. CFP동안 CSMA-CA는 사용이 허락되지 않는다.

#### inactive period 
슈퍼프레임은 inactive period를 가질 수도 있다. 이건 디바이스가 절전모드로 들어가는 것을 허락한다. 절전모드동안, 코디네이터는 그것의 송수신기를 꺼서 배터리를 절약할 수 있다.

<br>
슈퍼 프레임 구조는 코디네이터에 의해 정의되고, MLME-START.request primitive를 사용한 네트워크층에 의해 구성된다. BI(Beacon Interval)은 두 연이은 비콘들 사이의 시간 주기다. BI는 macBeaconOrder라는 속성과 aBaseSuperframeDuration 구성요소의 값에 의해 결정된다. 방정식은 아래와 같다.
#### BI = aBaseSuperframeDuration x 2^macBeaconOrder (Symbols)
예를 들어 960 심볼 aBase와 BO가 2라면 비콘 간격은 3840 심볼이다.<br>
macBeaconOrder는 0부터 14사이의 값을 가질 수 있다. 만약에 15가 되면 네트워크는 nonBeacon-Enabled라고 여겨지고 어떤 슈퍼프레임도 응답되지 않는다.
<br>
비슷하게 슈퍼프레임 기간(SD)라고 알려진 슈퍼프레임 엑티브 기간의 길이는 다음 방정식으로 계산된다.
#### SD = aBaseSuperframeDuration x 2^SO (Symbols)
여기서 SO는 macSuperframeOrder 속성의 값이다. 슈퍼프레임 기간은 비콘 간격을 초과할수없다. (BI > SD) 그러므로 SO의 값은 항상 BO의 값보다 작다.
<br>
nonBeacon-Enabled 네트워크(BO가 15인 경우처럼)에서 코디네이터는 네트워크의 디바이스로부터 비콘 요청 명령을 받지 않는 이상 비콘을 전송하지 않는다. <br>
비콘 요청 명령은 코디네이터의 위치를 찾기 위해 디바이스에 의해 사용된다. 비콘 요청 명령의 형식은 뒤에서 다룬다. nonBeacon-Enabled 네트워크의 PAN 코디네이터는 macSuperframeOrder의 값을 15로 설정했다.<br>

Beacon-Enabled 네트워크에서 PAN 코디네이터를 포함한 어떤 코디네이터든 비콘을 전송하는 옵션을 갖고, 그것만의 슈퍼프레임을 만든다. 아래 그림은 PAN 코디네이터와 또다른 코디에니터가 같은 네트워크에서 비콘들을 전송할 때 요구되는 타이밍을 보여준다. 

3.8 그림!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<br>
코디네이터는 PAN코디네이터 슈퍼프레임의 비활성기간(Inactive period)에만 비콘들의 전송을 시작할 수 있다. PAN 코디네이터 비콘은 received beacon으로써 참조된다. 그 외의 다른 코디네이터의 비콘은 transmitted beacon이라고 알려진다. 양쪽 슈퍼프레임의 활성 기간은 반드시 같은 길이여야한다.<br>
PAN코디네이터 이외의 코디네이터는 그것의 슈퍼프레임의 시작을 명시하기 위해 오직 비콘을 전송한다. 그리고 슈퍼프레임의 끝부분은 PAN 코디네이터의 슈퍼프레임과 같을 수 있다.<br>
만약 디바이스가 확장된 기간에 GTS를 사용하지 않는다면, 그것의 GTS는 만료되고 코디네이터는 그 특정 GTS를 다른 디바이스에게 할당할 수 있다. GTS 만료의 결과로 생긴 비활성기간은 항상 슈퍼프레임 두배 길이의 정수배다. 이 정수배의 값은 macBeaconOrder에 달려있다.<br>
BO가 0이상 8이하인 경우, 정수배 = 2^(8-BO) <br>
BO가 8이상 14이하인 경우, 정수배 = 1 <br>
예를 들어 BO가 7인 디바이스는 그것의 GTS를 4개의 연속된 슈퍼프레임동안 사용하지 않으면 GTS는 만료된다.

### Interframe spacing(IFS)
디바이스에서 다른 디바이스로 데이터를 전송할 때, 보낸 측 디바이스는 반드시 성공적으로 전송된 프레임들이 수신측 디바이스가 받은 프레임을 다음 프레임이 도착하기 전에 처리하도록 기다린다. 이건 프레임내 공간할당(IFS)으로 알려져있다. IFS의 길이는 전송된 프레임 크기에 달려있다. aMaxSIFSFrameSize와 같거나 더 작은 사이즈를 가진 MPDU는 짧은 프레임으로 간주된다. 그리고 이것을 초과하는 바이트들을 가진 프레임은 긴 프레임이다. <BR>

짧은 프레임이후의 대기시간은 short IFS라고 참조된다. SIFS의 최소값은 macMinSIFSPeriod다. 비슷하게 긴 프레임은 long IFS(LIFS)에 따른다. aMaxSIFSFrameSize는 12심볼 macMinSIFSPeriod는 40심볼이다.<br>

아래 그림은 인터프레임 공간할당의 두 시나리오를 보여준다.
<br>
그림3.9!!!!!!!!!!!!!!!!!!!!!!!!
<br>
첫 번째는 메시지가 응답되었고 확인응답 프레임 사이의 대기시간을 보여준다. 다음 프레임은 프레임길이에 따라 LIFS와 SIFS다. 프레임 전송하고부터 확인응답을 수신하기까지의 기간은 그림에서 tack으로 나타난다.<br>
두번째 그림은 만약 확인응답이 필요없다면, 최소 인터프레임 공간할당은 프레임이 전송된 시점부터 시작한다.<br>

### CSMA-CA
IEEE 802.15.4가 제공하는 채널 접근 메커니즘은 CSMA-CA다. 디바이스가 전송을 하고싶을때마다 그건 해당 채널이 다른 디바이스에 의해 수행되고 있지 않은것을 확실히하기 위해 CCA를 수행한다. 그리고 디바이스는 그것만의 신호로 전송을 시작한다. 전에도 살펴봤지만 여기선 좀 더 자세히 다룬다.
<br>
비콘들을 전송할때 CSMA-CA를 사용하지 않고 디바이스가 채널을 접근하는 두 가지 경우가 있다.<br>
1. CFP기간동안 채널 엑세스를 하는 경우<br>
2. 데이터 요청 명령을 확인한 즉시 전송. 그러니까, 만약 디바이스가 코디네이터로부터 데이터를 요청하면, 코디네이터는 심지어 CAP 동안에도 CSMA-CA를 수행하지 않고 확인응답과 데이터를 즉시 보낸다.<br>
<br>
CSMA-CA에는 두가지 타입이 있다. slotted와 unslotted다. <br>
#### slotted CSMA-CA
이건 슈퍼프레임 구조가 있는 동안 CSMA-CA를 동작하기 위해 참조된다. 슈퍼프레임은 16개의 똑같은 타임 슬롯들로 엑티브 기간을 나눈다. CSMA-CA 알고리즘의 백오프 기간은 일렬의 특정 타임 슬롯이 되어야 한다.
#### unslotted CSMA-CA
unslotted CSMA-CA 알고리즘은 슈퍼프레임 구조가 없을 때 쓰인다. 결과적으로 백오프 슬롯도 필요없다. 논비콘 네트워크는 항상 이 알고리즘을 채널 엑세스에 사용한다.
<br>
만약 CCA가 바쁜 채널을 표시하면, 디바이스는 랜덤 기간동안 백오프를 하고 다시 시도한다. 슬롯과 언슬롯 CSMA-CA의 랜덤 백오프 기간은 백오프 단위의 정수배다. 백오프 단위 기간은 aUnitBackoffPeriod(맥의 구성요소)와 같다.
<br>
아래 그림은 CSMA-CA의 알고리즘을 보여준다. 
3.10 그림 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
<br>
첫번째 단계에서 슬롯이냐 언슬롯이냐가 결정된다. CSMA-CA알고리즘에서는 변수 세 개가 사용된다. BE(backoff exponent), NB(number of back off), CW(contention window)길이 이다.<br>
알고리즘이 바쁜 채널을 만날 떄마다 랜덤 기간동안 백오프를 한다. 그리고 BE는 이 랜덤 기간의 허락된 범위를 결정한다. 이 랜덤 백오프는 단위백오프기간이 곱해진 0부터 2^BE - 1사이의 정수다. <br>
Back-off = (0 ~ 2^BE-1 사이의 랜덤정수) X aUnitBackoffPeriod <br>

