## 네트워크층 프로토콜
대체로 네트워크층은 하나의 주 프로토콜과 3개의 보조 프로토콜로 이루어져있다. 
![image](https://user-images.githubusercontent.com/38284141/51158798-74e26d00-18c9-11e9-8863-f3f9eeba95a6.png)
여기서는 IPv4와 ICMP를 다룬다.

### IPv4
IPv4에서 사용하는 패킷은 데이터그램이라고 하고 형식은 아래 그림과 같다. 헤더에는 라우팅과 전송에 필요한 정보가 있고 페이로드는 데이터다.<br>
![image](https://user-images.githubusercontent.com/38284141/51160302-b591b480-18d0-11e9-9560-6bf45ba0bc15.png)

#### 단편화
MTU라는게 있다. maximum transfer unit, 최대 전송 단위다. 이 최대 전송 단위는 각 물리적인 네트워크 프로토콜마다 다르다.<br>
큰 IP 패킷들이 적은 MTU를 갖는 링크를 통하여 전송되려면 여러개의 작은 패킷으로 쪼개어/조각화 되어 전송되어야 함. 이걸 단편화라고 한다.<br>

#### 재조립(Reassembly)
일단 단편화되면, 최종 목적지에 도달할 때까지 재조립되지 않는 것이 일반적임. 즉 패킷이 단편화되면 최종 목적지 호스트에서만 재조립 된다.

### ICMPv4(Internet Control Message Protocol version 4)
IPv4는 오류 보고와 오류 수정 기능이 없다. 그리고 호스트와 관리 질의를 위한 메커니즘이 없다.<br>
그래서 ICMPv4는 위의 두 단점을 보완하기 위해 설계됐다. ICMP는 IP프로토콜이랑 단짝이다. <br>
ICMPv4메시지는 크게 두 가지로 나뉜다. 오류보고(error-reporting) 메세지와 질의(query) 메시지다.<br>
#### 오류보고 메시지
IP는 신뢰성 없는 프로토콜이니까 ICMP의 주요 임무 중 하나는 IP 데이터그램의 프로세싱동안 발생하는 오류를 보고하는 것이다.<br>
다만 여기서 ICMP는 단지 보고만 할 뿐 수정은 하지 않는다. 오류 수정은 상위 프로토콜에게 맡긴다.<br>
ICMP의 오류 메시지는 항상 최초 발신지에게 보내진다. 왜냐면 데이터그램으로부터 알수있는 경로에 대한 정보는 근원지와 목적지 IP밖에 없기 때문이다.<br>
대표적인 오류메시지로는 목적지도달불가(destination unreachable)메시지와 근원지 억제(source quench) 메시지가 있다.<br>
목적지 도달불가 메시지는 데이터그램이 최종 목적지에 도달하지 못한 이유를 알려주기 위해 0부터 15까지의 코드를 사용한다.<br>
근원지 억제 메시지는 발신자에게 네트워크에 충돌이 발생해서 데이터그램이 폐기됐음을 알린다.<br>
#### 질의 메시지
질의메시지는 인터넷에서 호스트나 라우터가 활성화됐는지 알아보거나 두 장치 사이의 클록이 동기화됐는지 등을 확인한다.<br>
요청과 응답이 한 쌍으로 동작한다.


## 이동 IP
노트북과 모바일 등이 보편화되면서 이동 IP기술이 중요해졌다. 이 기술에서 가장 중요한 부분은 주소 지정이다.
### 주소지정
호스트가 네트워크를 이동할 때 IP주소 구조도 바뀌는데 이 부분에 대해 대표적인 2가지 방법이 있다.<br>
첫 번째는 호스트가 DHCP를 사용해서 새로운 네트워크에서 새로운 주소를 획득해서 사용하는 방법이다.<br>
이 방법은 많은 문제가 있다. 네트워크 변경시마다 호스트가 재부팅되야 하고 데이터가 전송중이었으면 전송은 중단된다.<br>
그래서 좀 더 현실적인 두 번째 방법을 쓴다. 아예 주소를 2개 쓰는 것이다. 호스트는 원래주소(홈주소 home address)와 의탁주소(care-of address)를 갖는다. 홈 주소는 영구적으로 쓰고, 호스트의 영구적인 홈이 되는 네트워크인 홈네트워크에 호스트를 연결시킨다. 의탁 주소는 호스트가 네트워크를 이동할 때 마다 변경되며 이 주소는 호스트가 이동해서 도착한 네트워크인 외지 네트워크(foreign network) 주소이다.<br>
![image](https://user-images.githubusercontent.com/38284141/51177126-2604f980-1902-11e9-9919-948ea79e9620.png)



