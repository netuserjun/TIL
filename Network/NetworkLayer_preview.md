# 네트워크층 개요

## 네트워크층 서비스

### 패킷화(packetizing)
네트워크층의 첫 번째 의무. 발신지부터 목적지까지 내용의 변경이나 활용없이 페이로드를 운반하는 것.<br>
발신지 네트워크층은 상위계층 프로토콜로부터 페이로드를 수신한다. 여기에 발신지와 목적지 주소, 기타 정보를 헤더로 추가하고 <br>
데이터링크층에 전달한다. 이 패킷이 너무 커서 분할해야 하는 경우를 제외하고는 내용 변경이 일어나지 않는다.<br>

### 라우팅(routing) 
패킷이 목적지까지 갈 수 있도록 경로를 지정하는 것. 많은 경로 중에서 가장 좋은 경로를 찾는다.

### 포워딩(forwarding)
포워딩이란 라우터에 패킷이 도착했을 때 라우터가 취하는 행동이다. 이 행동을 위해 사용하는 의사결정 테이블을 포워딩테이블 혹은 라우팅테이블이라고 부른다. 라우터가 패킷을 수신했을 때 이 패킷을 다른 네트워크 하나로 포워딩하거나 여러 네트워크로 포워딩한다. 이 결정을 위해 라우터는 패킷 헤더에 있는 목적지 주소나 레이블 정보를 사용한다.

### 기타 서비스들
검사합을 통한 오류제어, 개념적인 혼잡제어

## 패킷 스위칭
현재 패킷 교환 네트워크에서 패킷의 경로를 찾기 위해서 두 가지 방식을 사용한다.<br>
1. 데이터그램 방식 2. 가상회선방식 <br>
### 데이터그램 방식
인터넷을 처음 만들 때 네트워크층 간소화를 위해서 모든 패킷을 독립적으로 처리하는 비연결형 서비스를 제공하도록 설계됐다.<br>
그래서 모든 패킷들은 각자 경로가 다를 수가 있었고, 각 패킷은 연관성이 없었다.<br>
이런 네트워크 형태의 교환기를 라우터라고 한다. 
![image](https://user-images.githubusercontent.com/38284141/51151847-aea67a00-18af-11e9-991d-36fef3bf8a24.png)

### 가상 회선 방식
이 방식에서 한 메시지에 속한 모든 패킷은 연관성이 있다. 데이터그램이 비연결 서비스라면 이건 연결지향 서비스다.<br>
이 방식을 사용하려면 발신지, 목적지 주소 뿐 아니라 가상회선을 정의하는 식별자인 레이블이 필요하다.<br>
![image](https://user-images.githubusercontent.com/38284141/51153169-76546b00-18b2-11e9-81b2-f2c3de33e8f1.png)
연결 설정, 데이터 전송, 연결 해제 3단계로 구성되는데 <br>
연결 설정 단계에서는 연결 지향성 서비스를 위해 발신자와 수신자의 주소로 테이블 항목을 생성한다. 즉 가상 회선을 위한 항목을 라우터가 생성한다.<br>
가상 회선을 생성하기위해 발신자와 수신자는 요청패킷, 확인응답 패킷을 서로 주고 받는다.<br>
요청 패킷이 이동할 때는 출력 레이블을 모르는 상태다.
![image](https://user-images.githubusercontent.com/38284141/51153214-a996fa00-18b2-11e9-9b0c-37abcf792605.png)
<br>
확인응답 과정에서는 수신측이 발신측으로부터 오는 패킷에 입력 레이블로 77을 선택해서 라우터 R4가 출력 레이블로 77을 갖게 된다.
![image](https://user-images.githubusercontent.com/38284141/51153463-a6e8d480-18b3-11e9-96df-5791600894e5.png)
연결 해제 단계에서는 라우터에 생성된 그 테이블 항목을 삭제한다.<br>


## 네트워크층 성능
네트워크층의 성능은 크게 3가지로 측정할 수 있다. 지연, 처리량, 패킷손실률이다.
### 지연
지연 종류에는 여러가지가 있다.<br>
#### 전송지연
호스트나 라우터가 패킷을 보낼 때 모든 비트를 즉시 보내는 게 아니고 비트를 하나씩 차례대로 보낸다.<br>
그래서 패킷의 첫 비트가 놓이는 시간과 마지막 비트가 놓이는 시간이 차이가 난다.<br>
따라서 패킷의 길이가 길수록 전송 지연도 길어진다.
transmission delay = (packet length) / (transmission rate)

#### 전파지연
전송매체를 통해 1비트가 전달되는데 걸리는 시간.
propagation delay = (Distance) / (propagation speed)

#### 처리지연
processing delay = time required to process a packet in a router or destination host
라우터나 호스트가 입력 포트로 패킷을 받은 뒤 헤더를 제거하고 오류를 탐지하고 출력포트로 패킷을 보내거나 상위계층으로 전달하는데 걸리는 시간.<br>
처리지연은 각 패킷마다 다르겠지만 일반적으로 평균으로 계산된다.

#### 큐잉지연
queuing delay = The time a packet wait in input and output queues in a router
일반적으로 라우터에서 발생하는 지연. 라우터는 입력포트에 처리할 패킷을 보관하는 큐와 출력포트에 전송할 패킷을 보관하는 큐를 갖고 있다.<br>
그래서 패킷이 큐를 빠져나가는데 걸리는 지연이다.

#### 전체지연
위에서 나온 지연들을 합한건데 만약 전체 경로상의 라우터 개수가 n개라고 했을 때,<br>
total delay = (n + 1) x (전송지연+전파지연+처리지연) + n x 큐잉지연 이다.
n개의 라우터가 있을 때 전체 링크는 n+1개니까 그만큼의 전송지연,전파지연,처리지연이 발생한다. 그리고 라우터에서 일어나는 큐잉지연은 n개다.<br>


### 처리량(throughput)
처치량은 초당 한 지점을 지나는 비트 수로 정의된다. 즉 한 지점의 실질적인 전송률이다.<br>
그런데 각기 다른 처치량을 가진 여러 개의 링크로 구성된 경로의 처리량은 어떨까?<br>
200kbps , 100kbps, 150kbps 의 처리량을 가지는 링크가 연속되게 이어져있다고 했을 때, 평균 전송률은 해당 링크들의 가장 작은 전송률인 100kbps가 된다. 암만 많이 보낼 수 있더라도 100kbps 이상의 데이터가 오지 않기 때문이다.<br>

### 패킷 손실(packet loss)
라우터가 패킷을 처리하는 동안 다른 수신된 패킷은 자기 차례까지 입력 버퍼에서 대기해야 한다. 하지만 라우터의 버퍼는 크기가 한정적이므로 가득 찰 경우 이후 패킷들은 폐기된다. 이런 경우 폐기된 패킷을 재전송하는데 더 많은 오버플로우와 패킷손실이 일어날 수 있다. 그래서 많은 큐잉 이론 연구가 이뤄졌다.


## IPv4 주소
TCP/IP프로토콜 그룹의 IP계층에서 사용되는 32비트 주소로 이루어진 식별자. 이 주소는 장치의 각 네트워크 연결마다 하나씩 있다.<br>
IPv4주소는 두 부분으로 구분되는 계층적 구조를 가진다. 앞부분은 접두사(prefix)로 네트워크를 정의하고, 뒷부분은 접미사(suffix)로 노드를 정의한다.
### 클래스기반 주소지정
![image](https://user-images.githubusercontent.com/38284141/51157440-46fa2a00-18c3-11e9-93bb-307bbcccbcd2.png)
클래스 A는 접두사가 8비트지만 처음 1비트가 클래스를 정의하므로 네트워크 식별자로 7비트만 가능하다. 2^7개의 네트워크만 A클래스 주소를 가진다.<br>
클래스 B는 첫 두비트가 10으로 고정이므로 2^14개의 네트워크만 가질 수 있다. <br>
C는 110이 고정이므로 2^21개의 네트워크를 가지고, D는 접두접미 구분없이 멀티캐스트주소로 사용한다.<br>
E클래스는 나중에 쓰려고 예약해둔 주소다.<br>
하지만 이런 클래스 기반 주소는 주소고갈 때문에 더이상 쓰지 않는다. 주소고갈 문제를 해결하기위해 서브네팅이나 수퍼네팅 방식을 도입했으나 방식이 불편하고 실용성이 부족해서 더이상 쓰지 않는다.<br>

### 클래스 없는 주소지정
IPv6 이전에 단기적 해결책으로 나온 방법. 전체 주소 공간을 가변길이 블록으로 나눈다. 그래서 접두사가 가변적이라 전체 주소 공간을 낭비없이 사용할 수 있다.


## IP패킷 포워딩
위에서 본 패킷 스위칭 방식에 따라 포워딩 방식이 달라진다. IP가 비연결형 프로토콜로 사용될 때 포워딩은 IP 데이터그램의 목적지 주소에 기반하고,
IP가 연결 지향형 프로토콜로 사용될 때 포워딩은 IP 데이터그램에 있는 레이블에 기반을 두고 포워딩한다.<br>

### 목적지 주소 기반 포워딩
호스트가 패킷을 보낼 때, 라우터가 패킷을 보낼 때 라우팅 테이블을 보고 다음 홉을 찾는다.<br>
![image](https://user-images.githubusercontent.com/38284141/51313778-c3426800-1a91-11e9-9ad5-495bebd56b38.png)
라우팅 테이블에는 마스크, 네트워크주소, 인터페이스 번호, 다음라우터 IP주소가 있다.<br>
클래스없는 주소체계에서 목적지 주소 내에 네트워크 정보가 없어서 아래 그림과 같이 목적지 주소 포워딩은  마스크가 큰 순서대로 탐색을 해서 시간이 많이 걸린다. 
![image](https://user-images.githubusercontent.com/38284141/51317506-18cf4280-1a9b-11e9-98af-100652356564.png)

### 목적지 레이블 기반 포워딩 
레이블 기반 포워딩은 연결형 프로토콜에서 쓴다. 테이블에서 레이블을 인덱스로 사용해서 탐색이 신속하다.
![image](https://user-images.githubusercontent.com/38284141/51317971-597b8b80-1a9c-11e9-8b13-2b4264665eb9.png)
